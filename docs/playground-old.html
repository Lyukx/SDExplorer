<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style type="text/css">
  html,body{margin:0; padding: 0;}
    .m-box .left,.m-box .right {text-align:center; }

    .m-box .left{float:left; width:400px;}
    .m-box .right{margin-left:410px;}
  </style>
</head>
<body>
  <div class="m-box">
    <div class="left">
      <textarea rows="40" cols="50" id="text"></textarea><br />
      <textarea rows="10" cols="50" id="group"></textarea><br />
      <button type="button" id="btn">Generate</button>
    </div>
    <div class="right"><div id="drawArea"></div></div>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" ></script>
<script src="sd.js"></script>
<script src="setupsvg.js"></script>
<script>
function parse(text, group_text){
  var object_map = new Map();
  var id_count = 0;
  var messages = [];
  var active_stack = [];

  var raw_messages = text.split("\n");
  for(var i = 0; i < raw_messages.length; i++){
    var raw_message = raw_messages[i].replace(/\s+/g,""); // Remove all spaces
    var tokens = raw_message.split(/->|:/g);
    if(tokens.length == 3){
      if(!object_map.has(tokens[0])){
        object_map.set(tokens[0], id_count);
        id_count = id_count + 1;
      }
      if(!object_map.has(tokens[1])){
        object_map.set(tokens[1], id_count);
        id_count ++;
      }

      var from = object_map.get(tokens[0]);
      var to = object_map.get(tokens[1]);
      var this_message = {id: i, from: from, to: to, message: tokens[2]};
      messages.push(this_message);
      active_stack.push(this_message);
    }

    else if(tokens.length == 1 && raw_message == "return"){
      var return_message = Object.assign({}, active_stack.pop());
      return_message.to = -1;
      return_message.message = "";
      messages.push(return_message);
    }

    else{
      console.log("error!");
    }
  }

  while(active_stack.length != 0){
    var return_message = Object.assign({}, active_stack.pop());
    return_message.to = -1;
    return_message.message = "";
    messages.push(return_message);
  }

  var objects = [];
  for(let entry of object_map.entries()){ // one entry is [object_name, object_id]
    objects.push({id: entry[1], name: entry[0]});
  }

  var groups = [];
  var raw_groups = group_text.split("\n");
  for(var i = 0; i < raw_groups.length; i++){
    var raw_group = raw_groups[i];
    if(raw_group == ""){
        break;
    }
    var tokens = raw_group.replace(/\s+/g,"").split(":");
    var name = tokens[0];
    var objs = tokens[1].split(",");
    for(var j = 0; j < objs.length; j++){
      objs[j] = object_map.get(objs[j]);
    }
    groups.push({id: id_count, name: name, objs: objs});
    id_count ++;
  }

  return [objects, messages, groups];
}

$("#btn").click(function(){
  var text = $("#text").val();
  var group_text = $("#group").val();

  var [objects, messages, groups] = parse(text, group_text);
  var elements = new sd.SDController(objects, groups, messages);
  elements.draw();
});
</script>
</body>
