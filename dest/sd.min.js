!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";var e=40,r=8,a=20;function o(t){this.id=t.id,this.displayName=t.name,void 0!=t.type&&(this.displayName+=":"+t.type),this.parent=-1,this.children=[],this.fold=!0,this.x=0,this.y=0,this.height=e,this.width=this.displayName.length*r+2*a}o.prototype.isGroup=function(){return 0!=this.children.length};var s=20,n=[],i=[],l=new Set;function d(t,e){!function(t,e){n=new Map,i=[],t.forEach(function(t){var e=new o(t);n.set(e.id,e)}),e.forEach(function(t){var e=new o(t);e.children=t.objs,n.set(e.id,e)}),e.forEach(function(e){t=e.objs;for(var r=0;r<t.length;r++)n.get(t[r]).parent=e.id})}(t,e),n.forEach(function(t,e,r){-1==t.parent&&i.push(t)}),i.sort(function(t,e){var r=t.id,a=e.id;return t.isGroup()&&(r=t.children[0]),e.isGroup()&&(a=e.children[0]),r-a});for(var r=s,a=0;a<i.length;a++)i[a].x=r,r+=i[a].width+s;f(),this.display=i,this.elementMap=n,this.displaySet=l}function f(){l.clear();for(let t of i)t.isGroup()&&!t.fold||l.add(t.id)}function c(t){this.from=t.from,this.id=t.id,this.count=t.count,this.valid=!1,this.scale=1,this.position=0,this.fromOffset=0,this.toOffset=0,1!=t.return?-1==t.to?this.return=!0:(this.to=t.to,this.message=t.message):this.return=t.return,void 0!=t.thread&&(this.thread=t.thread)}d.prototype.updateAfterReOrder=function(){var t=s;for(let e of i)e.x=t,e.isGroup()&&!e.fold?t+=10:t+=e.width+s},d.prototype.getGroupFoldInfo=function(){var t=new Set;for(let e of i)e.isGroup()&&!e.fold&&t.add(e.id);return t},d.prototype.unfoldUpdateStatus=function(t){var e=n.get(t);if(e.fold){for(var r=e.children,a=10,o=i.indexOf(e)+1,l=0;l<r.length;l++){var d=n.get(r[l]);d.x=a+e.x,i.splice(o,0,d),o++,a+=d.width+s}for(var c=a-s+10-e.width;o<i.length;)i[o].x+=c,o++;e.width+=c,e.y-=10,e.height+=20,e.fold=!1;for(var p=e;-1!=p.parent;)(p=n.get(p.parent)).width+=c,p.height+=20,p.y-=10;f()}},d.prototype.foldUpdateStatus=function(t){var e=n.get(t);if(!e.fold){for(var r=e.children,a=0,o=0;o<r.length;o++){var l=n.get(r[o]);a=i.indexOf(l),i.splice(a,1)}for(var d=e.width-(8*e.displayName.length+2*s);a<i.length;)i[a].x-=d,a++;e.width-=d,e.y+=10,e.height-=20,e.fold=!0;for(var c=e;-1!=c.parent;)(c=n.get(c.parent)).width-=d,c.height-=20,c.y+=10;f()}},c.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message},c.prototype.isReturn=function(){return 1==this.return};var p,h,u,g,m,y,v,x,w,b,M,k,A,E=80;function F(t,e,r,a){p=[],h=new Map,u=[];for(let e of t){var o=new c(e);u.push(o),o.isReturn()||h.set(o.id,{from:o.from,to:o.to})}for(let t of u)if(-1!=t.to){for(;!r.has(t.from);){if(void 0==a.get(t.from)){t.from=-1;break}if(-1==(s=a.get(t.from).parent))break;t.from=s}for(;!r.has(t.to);){if(void 0==a.get(t.to)){t.to=-1;break}var s;if(-1==(s=a.get(t.to).parent))break;t.to=s}}m=e,L(),this.validMessages=p}function L(){g=[];for(var t=new Set,e=0;e<u.length;e++){var r=u[e];r.isReturn()?t.has(r.id)&&g.push(r):r.to!=r.from&&-1!=r.from&&-1!=r.to?(g.push(r),t.add(r.id)):r.valid=!1}p.length=0;var a=[],o=new O,s=new Map,n=E/4;for(e=0;e<g.length;e++){var i=g[e];if(i.isReturn()){var l=s.get(i.id)[0],d=e-s.get(i.id)[1];n+=E/2,l.scale=(d+1)/2,o.pop()}else s.set(i.id,[i,e]),n+=E/2,i.position=n,o.push(i),i.fromOffset=o.getOffset(i.from),i.toOffset=o.getOffset(i.to),i.valid||a.push(i),i.valid=!0,p.push(i)}for(var f=g.length;!o.isEmpty();){var c=o.pop();d=f-s.get(c.id)[1];n+=E/2,c.scale=(d+1)/2,f++}return a}function O(){this.stack=[],this.offset=new Map;for(let t of m)this.offset.set(t,0)}function S(){}F.prototype.foldUpdateStatus=function(t){for(let e of u)-1!=e.to&&(-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id));L()},F.prototype.getRawMessages=function(){return g},F.prototype.unfoldUpdateStatus=function(t,e){for(let a of u)if(-1!=a.to&&-1!=a.from){if(!t.has(a.from))for(a.from=h.get(a.id).from;!t.has(a.from);){if(-1==(r=e.get(a.from).parent))break;a.from=r}if(!t.has(a.to))for(a.to=h.get(a.id).to;!t.has(a.to);){var r;if(-1==(r=e.get(a.to).parent))break;a.to=r}}return L()},O.prototype.push=function(t){this.stack.push(t),this.offset.has(t.to)?this.offset.set(t.to,this.offset.get(t.to)+1):this.offset.set(t.to,0)},O.prototype.pop=function(){var t=this.stack.pop(),e=this.offset.get(t.to)-1;return e<0?this.offset.delete(t.to):this.offset.set(t.to,e),t},O.prototype.peek=function(){return this.stack[this.stack.length-1]},O.prototype.hasActive=function(t){return this.offset.has(t)},O.prototype.isEmpty=function(){return 0==this.stack.length},O.prototype.getOffset=function(t){return this.offset.has(t)?this.offset.get(t):0},S.prototype.output=function(t){},S.prototype.logFold=function(t){var e={time:Date(),type:"Fold",param:[t.id,t.displayName]};this.output(e)},S.prototype.logUnfold=function(t){var e={time:Date(),type:"Unfold",param:[t.id,t.displayName]};this.output(e)},S.prototype.logHinitbox=function(t){var e={time:Date(),type:"Hintbox",param:[t]};this.output(e)};var G,B,H,C,D=[],U=new S,I=[],N=["#CCC","#FF0000","#00FF00","0000FF","FFFF00","00FFFF","FF00FF"];function R(t,e,r){y=new d(t,e),M=y.elementMap,b=y.display,k=y.displaySet,this.logger=U,w=new Set([0]);for(var a=M.get(0);-1!=a.parent;)w.add(a.parent),a=M.get(a.parent);x=[0],v=new F(r,w,k,M),A=v.validMessages,at()}function j(t){y.unfoldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),b.forEach(function(t){Z=Math.max(Z,t.height)});for(var r=0;r<t.children.length;r++){var a=t.children[r],o=M.get(a),s=ot(o);s.attr("transform","translate("+t.x+", "+(t.y+Q)+")"),s.transition().attr("transform","translate("+o.x+", "+o.y+")"),d3.select("#baseLine"+a).transition().attr("transform","translate("+o.x+", "+o.y+")")}}(t),ht(v.unfoldUpdateStatus(k,M)),T(),U.logUnfold(t)}function W(t){y.foldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),Z=Math.max(Z,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),Z=P,b.forEach(function(t){Z=Math.max(Z,t.height)})}(t),v.unfoldUpdateStatus(k,M),ht([]),T(),U.logFold(t)}function X(t){for(var e=0;e<t.children.length;e++){var r=M.get(t.children[e]);if(r.isGroup()&&!r.fold)return!1}return!0}function Y(t){var e=[];for(e.push(t);0!=e.length;){var r=e[e.length-1];if(X(r))W(r),e.splice(e.length-1,1);else for(var a=0;a<r.children.length;a++){var o=M.get(r.children[a]);o.isGroup()&&(X(o)?W(o):e.push(o))}}}R.prototype.draw=function(){at();for(var t=0;t<b.length;t++)ot(b[t]);gt();for(let t of A)nt(t)},R.prototype.getMessages=function(){return A},R.prototype.getElementSet=function(){return k},R.prototype.getElements=function(){return b},R.prototype.getElementMap=function(){return M},R.prototype.getRawMessages=function(){return v.getRawMessages()},R.prototype.setLoops=function(t){D=t,vt()},R.prototype.updateAfterReOrder=function(){y.updateAfterReOrder()},R.prototype.setMessages=function(t){v=new F(t,w,k,M),A=v.validMessages,d3.select(".messages-layout").selectAll("*").remove();for(let t of A)nt(t);yt(),mt()};var z,_=!1;function T(){for(var t=0,e=H;e<H+G&&!(e>=b.length);e++)t=Math.min(b[e].y,t);var r=parseInt(d3.select(".objects-layout").attr("transform").split(/,|\)/)[1]);void 0==R.prototype.top?(d3.select(".objects-layout").attr("transform","translate(0,"+(r-t)+")"),R.prototype.top=t):R.prototype.top!=t&&(d3.select(".objects-layout").attr("transform","translate(0,"+(r+R.prototype.top-t)+")"),R.prototype.top=t)}R.prototype.getHint=function(){return z},R.prototype.setDiagramSize=function(t,e){G=t,B=e,_=!0,this.setDiagramDisplayHead(0,0)},R.prototype.setDiagramDisplayHead=function(t,e){H=t,C=e},R.prototype.getMiddleElementIndex=function(){return H+G/2},R.prototype.getMiddleElementX=function(){var t=this.getMiddleElementIndex();return t<b.length?b[t].x:-1},R.prototype.getHeadElementX=function(){return b[H].x},R.prototype.getMiddleMessageIndex=function(){return C+B/2},R.prototype.getMiddleMessageY=function(){var t=this.getMiddleMessageIndex();return t<A.length?A[t].position:-1},R.prototype.getHeadMessageY=function(){return A[C].position},R.prototype.getIndexByMessageId=function(t){for(var e=-1,r=-1,a=-1,o=-1,s=0;s<A.length;s++)if(A[s].id==t){r=s,o=A[s].position;break}if(-1!=r)for(var n=0;n<b.length;n++)if(b[n].id==A[r].from){e=n,a=b[n].x;break}return[e,r,a,o-60]},R.prototype.drawWindow=function(){for(var t=H;t<H+G&&!(t>=b.length);t++)ot(b[t]);q||d3.selectAll(".element").on("click",null),T(),gt();for(t=C;t<C+B&&!(t>=A.length);t++)nt(A[t]);vt()},R.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".mainthread-layout").remove(),d3.select(".baseline-layout").remove(),d3.select(".hint-box").remove(),z=void 0,at()},R.prototype.getFoldInfo=function(){return y.getGroupFoldInfo()},R.prototype.updateWithoutAnimation=function(t){for(let e of b){if(t.has(e.id))y.unfoldUpdateStatus(group.id),st(group,y),ut(v.unfoldUpdateStatus(k,M))}};var q=!0;R.prototype.disableFoldAndUnfold=function(){q=!1,d3.selectAll(".element").each(function(t){t.isGroup()&&d3.select(this).on("click",null)})},R.prototype.enableFoldAndUnfold=function(){q=!0,d3.selectAll(".element").each(function(t){t.isGroup()&&d3.select(this).on("click",function(t){t.fold?j(t):Y(t)})})},R.prototype.addHintByFunc=function(t){var e=M.get(t.from),r=e.x+e.width,a=t.position+40;pt(t.from,t.to,t.message,r,a),d3.selectAll(".message").each(function(e){e==t&&(it=d3.select(this).select(".message-click-active-block")).style("fill-opacity","0.4")})};var P=40,V=8,J=4,K=20,Q=10,Z=P,$=10,tt=80,et=tt/8,rt=90;function at(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","mainthread-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function ot(t){var e=d3.select(".objects-layout").append("g"),r=(t.displayName.length*V+2*K)/2,a=(_&&C+B<A.length?B:A.length)*tt+P+tt/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",r).attr("y1",0).attr("x2",r).attr("y2",a).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var o=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");t.isGroup()?o.style("fill","yellow"):o.style("fill","white");e.append("text").text(function(e){return t.displayName}).attr("transform","translate("+r+","+(P/2+J)+")").attr("text-anchor","middle").attr("font-family","Consolas");return e.attr("class","element").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){t.fold?j(t):Y(t)}),t.isGroup()&&!t.fold&&(e.style("fill-opacity","0"),d3.select("#baseLine"+t.id).style("opacity",0)),e}function st(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").attr({width:e.width,height:e.height}),e==t?(d3.select(this).style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))}),b.forEach(function(t){Z=Math.max(Z,t.height)});for(var r=0;r<t.children.length;r++){var a=t.children[r],o=M.get(a),s=ot(o);s.attr("transform","translate("+t.x+", "+(t.y+Q)+")"),s.attr("transform","translate("+o.x+", "+o.y+")"),d3.select("#baseLine"+a).attr("transform","translate("+o.x+", "+o.y+")")}}function nt(t){var e=M.get(t.from),r=M.get(t.to),a=e.x+e.width/2-$/2+t.fromOffset*$,o=t.position+et,s=t.scale*tt-2*et,n=r.x+r.width/2-$/2+t.toOffset*$,i=o+et,l=s-2*et;if(_){var d=H>0?b[H-1].x:b[0].x,f=H+G;f>=b.length&&(f=b.length-1);var c=b[f].x+b[f].width;a<d&&(a=d),n>c&&(n=c)}var p=M.get(t.from).x<M.get(t.to).x,h=d3.select(".messages-layout").append("g"),u=h.append("text").attr("class","message-text").text(function(e){return t.message});p?u.attr("transform","translate("+(a+K)+","+o+")"):u.attr("transform","translate("+(a-$)+","+o+")").attr("text-anchor","end"),h.append("line").attr("class","callLine").style("stroke","black").attr("x1",p?a+$:a).attr("y1",i).attr("x2",p?n:n+$).attr("y2",i).attr("marker-end","url(#end)"),h.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",p?n:n+$).attr("y1",i+l).attr("x2",p?a+$:a).attr("y2",i+l).attr("marker-end","url(#end)");var g="#CCC";void 0!=t.thread&&(-1==I.indexOf(t.thread)&&I.push(t.thread),g=N[I.indexOf(t.thread)%N.length]),h.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:$,height:l}).attr("transform","translate("+n+","+i+")").style("stroke","black").style("fill",g),h.attr("class","message").datum(t),h.append("rect").attr("class","message-click-active-block").attr({x:-K,y:-K,width:2*K+Math.abs(n-a),height:2*K+l}).attr("transform","translate("+Math.min(a,n)+","+i+")").style("fill","#99ccff").style("fill-opacity","0").datum(t.id),h.attr("class","message").datum(t).on("dblclick",function(e){var r=d3.select(this).select(".message-click-active-block");if(void 0!=it)if(it.style("fill-opacity","0"),it.datum()!=r.datum()){r.style("fill-opacity","0.4"),it=r;var a=d3.mouse(this)[0],o=d3.mouse(this)[1];d3.select(".hint-box").remove(),pt(t.from,t.to,t.message,a,o),z=t,U.logHinitbox(t.id)}else it=void 0,d3.select(".hint-box").remove(),z=void 0;else{r.style("fill-opacity","0.4"),it=r;a=d3.mouse(this)[0],o=d3.mouse(this)[1];pt(t.from,t.to,t.message,a,o),z=t,U.logHinitbox(t.id)}})}var it,lt,dt,ft,ct;rt=90;function pt(t,e,r,a,o){var s=d3.select("svg").append("g").attr("class","hint-box"),n=M.get(t).displayName,i=M.get(e).displayName,l=1,d=d3.select("svg");if(null!=d[0][0]){d=d.attr("viewBox");var f=window.innerWidth;l=d.split(" ")[2]/f}var c=(Math.max(n.length,i.length,r.length)+8)*V+2*K;s.append("rect").attr({x:0,y:0,width:c,height:rt}).style("fill","#FEF8DE").style("stroke","black"),s.append("text").text(function(t){return"Caller: "+n}).attr("transform","translate("+K+","+(rt/6+J)+")").style("font-family","Courier New"),s.append("text").text(function(t){return"Callee: "+i}).attr("transform","translate("+K+","+(rt/2+J)+")").style("font-family","Courier New"),s.append("text").text(function(t){return"Method: "+r}).attr("transform","translate("+K+","+(rt/6*5+J)+")").style("font-family","Courier New"),s.attr("transform","translate("+a+","+o+") scale("+l+")")}function ht(t){for(let e of t)e.valid&&nt(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=M.get(t.from),r=M.get(t.to),a=e.x+e.width/2-$/2+t.fromOffset*$,o=t.position+et,s=t.scale*tt-2*et,n=r.x+r.width/2-$/2+t.toOffset*$,i=o+et,l=s-2*et,d=M.get(t.from).x<M.get(t.to).x;d?d3.select(this).select(".message-text").transition().attr("transform","translate("+(a+K)+","+o+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(a-$)+","+o+")"),d3.select(this).select(".callLine").transition().attr("x1",d?a+$:a).attr("y1",i).attr("x2",d?n:n+$).attr("y2",i),d3.select(this).select(".callBackLine").transition().attr("x1",d?n:n+$).attr("y1",i+l).attr("x2",d?a+$:a).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:$,height:l}).attr("transform","translate("+n+","+i+")"),d3.select(this).select(".message-click-active-block").transition().attr({x:-K,y:-K,width:2*K+Math.abs(n-a),height:2*K+l}).attr("transform","translate("+Math.min(a,n)+","+i+")")}else d3.select(this).remove()}),yt(),mt()}function ut(t){for(let e of t)e.valid&&nt(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=M.get(t.from),r=M.get(t.to),a=e.x+e.width/2-$/2+t.fromOffset*$,o=t.position+et,s=t.scale*tt-2*et,n=r.x+r.width/2-$/2+t.toOffset*$,i=o+et,l=s-2*et,d=M.get(t.from).x<M.get(t.to).x;d?d3.select(this).select(".message-text").attr("transform","translate("+(a+K)+","+o+")"):d3.select(this).select(".message-text").attr("transform","translate("+(a-$)+","+o+")"),d3.select(this).select(".callLine").attr("x1",d?a+$:a).attr("y1",i).attr("x2",d?n:n+$).attr("y2",i),d3.select(this).select(".callBackLine").attr("x1",d?n:n+$).attr("y1",i+l).attr("x2",d?a+$:a).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").attr({x:0,y:0,width:$,height:l}).attr("transform","translate("+n+","+i+")"),d3.select(this).select(".message-click-active-block").attr({x:-K,y:-K,width:2*K+Math.abs(n-a),height:2*K+l}).attr("transform","translate("+Math.min(a,n)+","+i+")")}else d3.select(this).remove()}),yt(),mt()}function gt(){for(let o of x){for(var t=M.get(o);!k.has(t.id)&&-1!=t.parent;)t=M.get(t.parent);var e=t.x+t.width/2-$/2,r=.75*tt,a=A.length*tt;d3.select(".mainthread-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:$,height:a}).attr("transform","translate("+e+","+r+")").style("stroke","black").style("fill","#CCC")}}function mt(){d3.selectAll(".mainThreadActiveBar").remove(),gt()}function yt(){var t=(_&&C+B<A.length?B:A.length)*tt+P+tt/2;d3.selectAll(".baseLine").attr("y2",t)}function vt(){d3.select(".loop-layout").selectAll("*").remove();var t=new Map;for(let e of A)t.set(e.id,e);for(let h of D){var e=h.represent,r=Number.MAX_SAFE_INTEGER,a=0,o=void 0;for(let c of e){var s=t.get(c.id);void 0==o&&(o=s);var n=M.get(s.from),i=M.get(s.to),l=n.x+n.width/2,d=i.x+i.width/2;if(l>d){var f=l;l=d,d=f}d+=60,(l-=95)<r&&(r=l),d>a&&(a=d)}var c=o.position-10,p=e.length*tt;(f=d3.select(".loop-layout").append("g")).attr("class","loop").datum(e[0]),f.append("line").attr({x1:0,y1:0,x2:a-r,y2:0}).style("stroke","blue"),f.append("line").attr({x1:0,y1:p,x2:a-r,y2:p}).style("stroke","blue"),f.append("line").attr({x1:0,y1:0,x2:0,y2:p}).style("stroke","blue"),f.append("line").attr({x1:a-r,y1:0,x2:a-r,y2:p}).style("stroke","blue"),f.append("rect").attr({x:0,y:0,width:80,height:20}).style("fill","white").style("stroke","blue").style("fill-opacity","1"),f.append("text").text(function(t){return"loop <"+h.repeat+">"}).attr("transform","translate(4, 16)"),f.attr("transform","translate("+r+","+c+")")}}function xt(t,e){this.represent=t,this.repeat=e,this.children=[],this.depth=1}function wt(t,e,r){for(var a=e;a<e+r;a++)if(!t[a].sameRepresent(t[a+r]))return!1;return!0}function bt(t,e,r,a){for(var o=[],s=[],n=0,i=e;i<e+r;i++)o=o.concat(t[i].represent),s.push(t[i]),t[i].depth>n&&(n=t[i].depth);var l=new xt(o,a);return l.children=s,l.depth=n+1,l}function Mt(t){var e=[];if(0==t.children.length)return e;var r=[];for(r.push(t);0!=r.length;){var a=r.pop();e.push(a);for(var o=0;o<a.children.length;o++)a.children[o].repeat>1&&r.push(a.children[o])}return e}function kt(t){for(var e=function(t){for(var e=[],r=0;r<t.length;r++)e.push(new xt([t[r]],1));for(var a=1,o=100>e.length/2?e.length/2:100;a<=o;){for(r=0;r<=e.length-2*a;r++){for(var s=1;wt(e,r,a)&&(e.splice(r+a,a),s++,!(r>e.length-2*a)););if(s>1){var n=bt(e,r,a,s);e.splice(r,a,n)}}a++}return e}(t),r=[],a=[],o=0;o<e.length;o++)r=r.concat(Mt(e[o])),a=a.concat(e[o].represent);this.result=[r,a]}xt.prototype.sameRepresent=function(t){if(this.represent.length!=t.represent.length)return!1;for(var e=0;e<this.represent.length;e++)if(!this.represent[e].equals(t.represent[e]))return!1;return!0};var At,Et,Ft,Lt,Ot,St,Gt,Bt,Ht,Ct=252,Dt=360,Ut=0,It=0;function Nt(t){void 0!=t.objects&&void 0!=t.messages?(void 0==t.groups&&(t.groups=[]),void 0!=t.width&&(At=t.width),void 0!=t.height&&(Et=t.height),function(t){void 0==At&&(At=window.innerWidth);void 0==Et&&(Et=window.innerHeight-100);[Ft,Lt,Ot,St]=[0,0,0,0],Bt=1,ft=-10,ct=-10,d3.select("svg").remove(),(lt=d3.select("#"+t).append("svg").attr("width",At).attr("height",Et).call(d3.behavior.zoom().scaleExtent([.2,10]).on("zoom",function(){if(Bt!==d3.event.scale){var t=Bt/d3.event.scale;Bt=d3.event.scale,ft=Ft-t*(Ft-ft),ct=Math.max(Lt-t*(Lt-ct),2*dt.top),lt.attr("viewBox",ft+" "+ct+" "+At/Bt+" "+Et/Bt);var e=d3.select(".hint-box");if(null!=e[0][0]){var r=e.attr("transform").split(" ");e.attr("transform",r[0]+" scale("+1/Bt+")")}jt()}}))).attr("viewBox","0 0 "+At+" "+Et),lt.on("dblclick.zoom",null),lt.on("mousedown",function(){Gt=!0,Ot=d3.mouse(this)[0],St=d3.mouse(this)[1]}),document.body.onmouseup=function(){Gt=!1},lt.on("mousemove",function(){Ft=d3.mouse(this)[0],Lt=d3.mouse(this)[1],Gt&&(ft=ft-d3.mouse(this)[0]+Ot,ct=Math.max(ct-d3.mouse(this)[1]+St,2*dt.top),lt.attr("viewBox",ft+" "+ct+" "+At/Bt+" "+Et/Bt),jt())}),lt.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5")}(t.drawAreaId),dt=new R(t.objects,t.groups,t.messages),this.rawMessageBeforeComress=t.messages,dt.setDiagramSize(Ct,Dt),dt.setDiagramDisplayHead(Ut,It),dt.drawWindow(),dt.getElementSet(),Ht=dt.getElementMap(),this.logger=dt.logger,void 0!=t.loops&&dt.setLoops(t.loops)):console.log("Error! Objects or messages undefined!")}function Rt(t,e,r){for(var a=Ht.get(r);-1!=a.parent;)a=Ht.get(a.parent);var o=[];if(a.isGroup()&&!a.fold){var s=t.indexOf(a)+1;for(let e=a.children.length;e>0;e--)t[s].isGroup()&&!t[s].fold&&(e+=t[s].children.length),o.push(t[s]),t.splice(s,1)}if(t.splice(t.indexOf(a),1),t.splice(e,0,a),0!=o.length)for(let r=0;r<o.length;r++)t.splice(e+1+r,0,o[r]);return o.length}function jt(){var t;(-1!=dt.getMiddleElementX()&&ft>=dt.getMiddleElementX()&&Xt(dt.getMiddleElementIndex(),It),Ut>0&&ft<=dt.getHeadElementX())&&((t=Ut-Ct/2)<0&&(t=0),Xt(t,It));(-1!=dt.getMiddleMessageY()&&ct>=dt.getMiddleMessageY()&&Xt(Ut,dt.getMiddleMessageIndex()),It>0&&ct<=dt.getHeadMessageY())&&((t=It-Dt/2)<0&&(t=0),Xt(Ut,t));Yt()}function Wt(t,e,r,a,o,s){Ut=Math.max(t-Ct/2,0),It=Math.max(e-Dt/2,0),Xt(Ut,It),ft=r,ct=a,lt.attr("viewBox",ft+" "+ct+" "+o+" "+s),Yt()}function Xt(t,e){dt.clearAll(),Ut=t,It=e,dt.setDiagramDisplayHead(t,e),dt.drawWindow()}function Yt(){d3.select(".objects-layout").attr("transform","translate(0,"+(ct-dt.top)+")"),d3.select(".baseline-layout").attr("transform","translate(0,"+(ct-dt.top)+")")}Nt.prototype.isMessageDisplayed=function(t){var e=dt.getMessages();for(let r of e)if(r.id==t.id)return!0;return!1},Nt.prototype.locate=function(t,e,r){var[a,o,s,n]=dt.getIndexByMessageId(t);return-1!=a&&-1!=o&&(Wt(a,o,s,n,e,r),!0)},Nt.prototype.getHint=function(){return dt.getHint()},Nt.prototype.nearby=function(t){var e=this.getElements(),r=this.getMessages(),a=(Ht.get(t.from),r.indexOf(t)),o=new Set,s=0;for(let t=0;t<50&&!(a+t>=r.length);t++){var n=r[a+t];o.has(n.from)||(o.add(n.from),s+=Rt(e,s,n.from),s++),o.has(n.to)||(o.add(n.to),s+=Rt(e,s,n.to),s++)}dt.updateAfterReOrder(),Xt(0,It),Yt(),this.locate(t.id,At/Bt,Et/Bt)},Nt.prototype.addHint=function(t){dt.addHintByFunc(t)},Nt.prototype.getMessages=function(){return dt.getMessages()},Nt.prototype.getElements=function(){return dt.getElements()},Nt.prototype.getElementMap=function(){return dt.getElementMap()},Nt.prototype.getContext=function(){return[Ut,It,ft,ct,At/Bt,Et/Bt]},Nt.prototype.resume=function(t){Wt(t[0],t[1],t[2],t[3],t[4],t[5]),Bt=At/t[4]},Nt.prototype.compress=function(){var t=dt.getRawMessages(),e=new kt(dt.getMessages()),r=new Set;for(let t of e.result[1])r.add(t.id);var a=[];for(let e of t)r.has(e.id)&&a.push(e);return dt.setMessages(a),dt.setLoops(e.result[0]),dt.disableFoldAndUnfold(),[e.result[0],a]},Nt.prototype.decompress=function(){this.setLoops([]),dt.setMessages(this.rawMessageBeforeComress),d3.select(".loop-layout").selectAll("*").remove(),dt.enableFoldAndUnfold()},Nt.prototype.setLoops=function(t){dt.setLoops(t)},t.SDController=R,t.SDViewer=Nt,Object.defineProperty(t,"__esModule",{value:!0})});