!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.name=t.name,this.parent=-1,this.children=[],this.x=0,this.y=0,this.height=j,this.width=this.name.length*O+2*E,this.fold=!0}function a(t,a){var s=new Map;return t.forEach(function(t){t.name=t.name+":"+t.type;var a=new e(t);s.set(a.id,a)}),a.forEach(function(t){var a=new e(t);a.children=t.objs,s.set(a.id,a)}),a.forEach(function(e){t=e.objs;for(var a=0;a<t.length;a++){s.get(t[a]).parent=e.id}}),s}function s(t,e){L=a(t,e),L.forEach(function(t,e,a){-1==t.parent&&A.push(t)}),A.sort(function(t,e){var a=t.id,s=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(s=e.children[0]),a-s});for(var s=S,r=0;r<A.length;r++)A[r].x=s,s+=A[r].width+S;this.total=L,this.display=A}function r(t){this.from=t.from,this.to=t.to,this.message=t.message,this.callee=t.callee,this.id=-1,this.valid=!1,this.scale=1,this.position=0}function i(t,e){this.messages=[],this.origin=[],this.mainThreads=e;for(var a=0;a<t.length;a++){var s=new r(t[a]);s.id=a,this.messages.push(s),this.origin.push({from:s.from,to:s.to})}D=this.origin,this.firstValidMsg=this.messages[0],this.lastValidMsg=this.messages[this.messages.length-1],this.validMessages=this.messages}function n(t,e,a){var r=new s(t,e);G=r,J=r.total,K=r.display;var n=new Set;n.add(0);for(var o=J.get(0);-1!=o.parent;)n.add(o.parent),o=J.get(o.parent);I=n;var d=new Set;K.forEach(function(t){t.isGroup()&&!t.fold||d.add(t.id)});var h=new i(a,n);h.updateMessageInit(J,d),h.updateStatus(),Q=h.validMessages,R=h.origin,Y=h,l(),V=!1}function o(){for(var t=0,e=T;e<T+B&&!(e>=K.length);e++)t=Math.min(K[e].y,t);var a=parseInt(d3.select(".objects-layout").attr("transform").split(/,|\)/)[1]);void 0==n.prototype.top?(d3.select(".objects-layout").attr("transform","translate(0,"+(a-t)+")"),n.prototype.top=t):n.prototype.top!=t&&(d3.select(".objects-layout").attr("transform","translate(0,"+(a+n.prototype.top-t)+")"),n.prototype.top=t)}function l(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function d(){var t=Y.lastValidMsg,e=Y.firstValidMsg,a=t.position-e.position+W+4*_;I.forEach(function(t){var s=J.get(t),r=s.x+s.width/2-F/2,i=e.position-2*_;d3.select(".messages-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:F,height:a}).attr("transform","translate("+r+","+i+")").style("stroke","black").style("fill","#CCC")})}function h(){var t=Y.lastValidMsg,e=Y.firstValidMsg,a=t.position-e.position+W+4*_,s=new Set;K.forEach(function(t){t.isGroup()&&!t.fold||s.add(t.id)}),I.forEach(function(t){if(s.has(t)){var r=J.get(t),i=r.x+r.width/2-F/2,n=e.position-2*_;d3.select(".mainThreadActiveBar").attr({x:0,y:0,width:F,height:a}).attr("transform","translate("+i+","+n+")")}})}function c(t){G.unfoldUpdateStatus(t.id);var e=new Set;K.forEach(function(t){t.isGroup()&&!t.fold||e.add(t.id)}),Y.updateMessageOnUnfold(J,e),y(t,Y.updateStatus()),h()}function f(t){G.foldUpdateStatus(t.id),Y.updateMessageOnFold(t),Y.updateStatus(),v(t),h()}function g(t){var e=J.get(t.from),a=J.get(t.to),s=e.x+e.width/2-F/2,r=t.position+_,i=t.scale*W-2*_,n=a.x+a.width/2-F/2,o=r+_,l=i-2*_;if(V){var d=T>0?K[T-1].x:K[0].x,h=T+B;h>=K.length&&(h=K.length-1);var c=K[h].x;s<d&&(s=d),n>c&&(n=c)}var f=J.get(t.from).x<J.get(t.to).x,g=d3.select(".messages-layout").append("g");f?g.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s+P)+","+r+")"):g.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s-F)+","+r+")").attr("text-anchor","end"),g.append("line").attr("class","callLine").style("stroke","black").attr("x1",f?s+F:s).attr("y1",o).attr("x2",f?n:n+F).attr("y2",o).attr("marker-end","url(#end)"),g.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",f?n:n+F).attr("y1",o+l).attr("x2",f?s+F:s).attr("y2",o+l).attr("marker-end","url(#end)"),g.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:F,height:l}).attr("transform","translate("+n+","+o+")").style("stroke","black").style("fill","#CCC"),g.append("rect").attr("class","message-click-active-block").attr({x:-P,y:-P,width:2*P+Math.abs(n-s),height:2*P+l}).attr("transform","translate("+Math.min(s,n)+","+o+")").style("fill","#99ccff").style("fill-opacity","0").datum(t.id),g.attr("class","message").datum(t).on("click",function(t){var e=d3.select(this).select(".message-click-active-block");if(void 0!=U)if(U.style("fill-opacity","0"),U.datum()!=e.datum()){e.style("fill-opacity","0.4"),U=e;var a=d3.mouse(this)[0],s=d3.mouse(this)[1];console.log(a,s)}else U=void 0;else{e.style("fill-opacity","0.4"),U=e;var a=d3.mouse(this)[0],s=d3.mouse(this)[1];console.log(a,s)}})}function p(t){for(var e=0;e<t.children.length;e++){var a=J.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function u(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,s=(V&&C+H<Q.length?H:Y.validMessageNum)+1,r=s*W+q/2+X/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",r).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var i=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?i.style("fill","yellow"):i.style("fill","white"),e.append("text").text(function(e){return t.name}).attr("transform","translate("+t.width/2+","+(t.height/2+z)+")").attr("text-anchor","middle"),e.attr("class","element-rectangle").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){if(t.fold)c(t);else{var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(p(a))f(a),e.splice(e.length-1,1);else for(var s=0;s<a.children.length;s++){var r=J.get(a.children[s]);r.isGroup()&&(p(r)?f(r):e.push(r))}}}}),e}function m(){d3.selectAll(".message").each(function(t){if(!t.valid)return void d3.select(this).remove();var e=J.get(t.from),a=J.get(t.to),s=e.x+e.width/2-F/2,r=t.position+_,i=t.scale*W-2*_,n=a.x+a.width/2-F/2,o=r+_,l=i-2*_,d=J.get(t.from).x<J.get(t.to).x;d?d3.select(this).select(".message-text").transition().attr("transform","translate("+(s+P)+","+r+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(s-F)+","+r+")"),d3.select(this).select(".callLine").transition().attr("x1",d?s+F:s).attr("y1",o).attr("x2",d?n:n+F).attr("y2",o),d3.select(this).select(".callBackLine").transition().attr("x1",d?n:n+F).attr("y1",o+l).attr("x2",d?s+F:s).attr("y2",o+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:F,height:l}).attr("transform","translate("+n+","+o+")")});var t=(V&&C+H<Q.length?H:Y.validMessageNum)+1,e=t*W+q/2+X/2;d3.selectAll(".baseLine").attr("y2",e)}function y(t,e){d3.selectAll(".element-rectangle").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),K.forEach(function(t){q=Math.max(q,t.height)});for(var a=0;a<t.children.length;a++){var s=t.children[a],r=J.get(s),i=u(r);i.attr("transform","translate("+t.x+", "+(t.y+N)+")"),i.transition().attr("transform","translate("+r.x+", "+r.y+")"),d3.select("#baseLine"+s).transition().attr("transform","translate("+r.x+", "+r.y+")")}e.forEach(function(t){g(t)}),m(),o()}function v(t){d3.selectAll(".element-rectangle").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),q=Math.max(q,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),q=X,K.forEach(function(t){q=Math.max(q,t.height)}),m(),o()}function x(t,e,a){k(),$=new n(t,e,a),$.setDiagramDisplaySize(rt,it),$.setDiagramDisplayHead(at,st),$.drawPart()}function w(){-1!=$.getMiddleObjX()&&et>=$.getMiddleObjX()&&M($.getMiddleObjIndex(),st),at>0&&et<=$.getHeadObjX()&&M(at-rt/2,st),-1!=$.getMiddleMsgY()&&tt>=$.getMiddleMsgY()&&M(at,$.getMiddleMsgIndex()),st>0&&tt<=$.getHeadMsgY()&&M(at,st-it/2),b()}function M(t,e){$.clearAll(),at=t,st=e,$.setDiagramDisplayHead(t,e),$.drawPart()}function b(){d3.select(".objects-layout").attr("transform","translate(0,"+(tt-$.getTopY())+")")}function k(){var t,e,a,s,r,i=window.innerWidth,n=window.innerHeight,o=1;et=-10,tt=-10,Z=d3.select("#drawArea").append("svg").attr("width",i).attr("height",n).call(d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",function(){if(o!==d3.event.scale){var a=o/d3.event.scale;o=d3.event.scale,et=t-a*(t-et),tt=Math.max(e-a*(e-tt),2*$.getTopY()),Z.attr("viewBox",et+" "+tt+" "+i/o+" "+n/o),w()}})),Z.on("mousedown",function(){r=!0,a=d3.mouse(this)[0],s=d3.mouse(this)[1]}),Z.on("mouseup",function(){r=!1,et=et-d3.mouse(this)[0]+a,tt=Math.max(tt-d3.mouse(this)[1]+s,2*$.getTopY()),Z.attr("viewBox",et+" "+tt+" "+i/o+" "+n/o),w()}),Z.on("mousemove",function(){t=d3.mouse(this)[0],e=d3.mouse(this)[1],r&&(et=et-d3.mouse(this)[0]+a,tt=Math.max(tt-d3.mouse(this)[1]+s,2*$.getTopY()),Z.attr("viewBox",et+" "+tt+" "+i/o+" "+n/o),w())}),Z.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5")}var j=40,O=10,E=20;e.prototype.isGroup=function(){return 0!=this.children.length};var S=20,L=[],A=[];s.prototype.unfoldUpdateStatus=function(t){var e=L.get(t);if(e.fold){for(var a=e.children,s=10,r=A.indexOf(e)+1,i=0;i<a.length;i++){var n=L.get(a[i]);n.x=s+e.x,A.splice(r,0,n),r++,s+=n.width+S}for(var o=s-S+10-e.width;r<A.length;)A[r].x+=o,r++;e.width+=o,e.y-=10,e.height+=20,e.fold=!1;for(var l=e;-1!=l.parent;)l=L.get(l.parent),l.width+=o,l.height+=20,l.y-=10}},s.prototype.foldUpdateStatus=function(t){var e=L.get(t);if(!e.fold){for(var a=e.children,s=0,r=0;r<a.length;r++){var i=L.get(a[r]);s=A.indexOf(i),A.splice(s,1)}for(var n=e.width-(10*e.name.length+2*S);s<A.length;)A[s].x-=n,s++;e.width-=n,e.y+=10,e.height-=20,e.fold=!0;for(var o=e;-1!=o.parent;)o=L.get(o.parent),o.width-=n,o.height-=20,o.y+=10}},r.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message&&this.callee==t.callee&&this.scale==t.scale};var D=[];i.prototype.updateMessageInit=function(t,e){this.messages.forEach(function(a){for(;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}for(;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},i.prototype.updateMessageOnFold=function(t){this.messages.forEach(function(e){-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id)})},i.prototype.updateMessageOnUnfold=function(t,e){this.messages.forEach(function(a){if(!e.has(a.from))for(a.from=D[a.id].from;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}if(!e.has(a.to))for(a.to=D[a.id].to;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},i.prototype.updateStatus=function(){var t,e=new Set,a=0,s=0,r=[],i=0;this.validMessages=[];for(var n=0;n<this.messages.length;n++){var o=this.messages[n];if(o.to==o.from||-1==o.from||-1==o.to)o.valid=!1;else if(this.mainThreads.has(o.from))e.clear(),e.add(o.to),o.valid||r.push(o),o.valid=!0,o.scale=1,a+=80+i,i=0,o.position=a,t=o.id,s++,this.validMessages.push(o);else if(e.has(o.from)){e.add(o.to),o.valid||r.push(o),o.valid=!0,o.scale=1;var l=this.messages[n-1];if(o.from==l.to)a+=40,o.position=a,i+=40;else{for(var d=0,h=l;h.from!=o.from;)d+=40,i-=40,h=this.messages[h.id-1];a+=80+d,o.position=a}for(var c=t;c<n&&(this.messages[c].scale+=1,this.messages[c].to!=o.from);c++);s++,this.validMessages.push(o)}else o.valid=!1}for(var f=null,g=null,n=this.messages.length-1;n>=0;n--){var o=this.messages[n];if(o.valid){f=o;break}}for(var n=0;n<this.messages.length;n++){var o=this.messages[n];if(o.valid){g=o;break}}return this.firstValidMsg=g,this.lastValidMsg=f,this.validMessageNum=s,r};var G,I,Y,B,H,V,T,C,U,X=40,z=4,P=20,N=10,F=10,W=80,_=W/8,q=X,J=[],K=[],Q=[],R=[];n.prototype.setDiagramDisplaySize=function(t,e){B=t,H=e,V=!0,this.setDiagramDisplayHead(0,0)},n.prototype.setDiagramDisplayHead=function(t,e){T=t,C=e},n.prototype.getMiddleObjX=function(){return this.getMiddleObjIndex()<K.length?K[this.getMiddleObjIndex()].x:-1},n.prototype.getMiddleObjIndex=function(){return T+B/2},n.prototype.getHeadObjX=function(){return K[T].x},n.prototype.getMiddleMsgY=function(){return this.getMiddleMsgIndex()<Q.length?Q[this.getMiddleMsgIndex()].position:-1},n.prototype.getMiddleMsgIndex=function(){return C+H/2},n.prototype.getHeadMsgY=function(){return Q[C].position},n.prototype.getTopY=function(){return this.top},n.prototype.drawAll=function(){K.forEach(function(t){u(t)}),o(),d(),Q.forEach(function(t){g(t)})},n.prototype.drawPart=function(){for(var t=T;t<T+B&&!(t>=K.length);t++)u(K[t]);d();for(var t=C;t<C+H&&!(t>=Q.length);t++)g(Q[t]);o()},n.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),l()};var Z,$,tt,et,at=0,st=0,rt=126,it=180;t.SDViewer=n,t.SVG=x,Object.defineProperty(t,"__esModule",{value:!0})});