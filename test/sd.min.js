!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.displayName=t.name,void 0!=t.type&&(this.displayName+=":"+t.type),this.parent=-1,this.children=[],this.fold=!0,this.x=0,this.y=0,this.height=M,this.width=this.displayName.length*b+2*k}function a(t,a){!function(t,a){E=new Map,t.forEach(function(t){var a=new e(t);E.set(a.id,a)}),a.forEach(function(a){var r=new e(a);r.children=a.objs,E.set(r.id,r),t=a.objs;for(var s=0;s<t.length;s++)E.get(t[s]).parent=a.id})}(t,a),E.forEach(function(t,e,a){-1==t.parent&&O.push(t)}),O.sort(function(t,e){var a=t.id,r=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(r=e.children[0]),a-r});for(var s=S,n=0;n<O.length;n++)O[n].x=s,s+=O[n].width+S;r(),this.display=O,this.elementMap=E,this.displaySet=L}function r(){L=new Set;for(let t of O)t.isGroup()&&!t.fold||L.add(t.id)}function s(t,e,a,r){A=[],B=new Map,G=[];for(let e of t)r.has(e.from)&&r.has(e.to)&&(G.push(e),B.set(e.id,{from:e.from,to:e.to}));for(let t of G){for(;!a.has(t.from);){if(-1==(s=r.get(t.from).parent))break;t.from=s}for(;!a.has(t.to);){var s=r.get(t.to).parent;if(-1==s)break;t.to=s}}I=e,n(),this.validMessages=A}function n(){var t=new o,e=D/4,a=0,r=[];A=[];for(var s=0;s<G.length;s++){var n=G[s];if(n.to==n.from||-1==n.from||-1==n.to)n.valid=!1;else if(I.has(n.from))e+=(t.stack.length+1)*D/2,n.position=e,(t=new o).push(n),n.fromOffset=t.getOffset(n.from),n.toOffset=t.getOffset(n.to),n.valid||r.push(n),n.valid=!0,n.scale=1,A.push(n);else if(t.hasActive(n.from)){n.valid||r.push(n),n.valid=!0,n.scale=1,A.push(n);for(a=0;t.peek().to!=n.from;){t.pop();a+=1}e+=(a+1)*D/2,n.position=e,t.stack.forEach(function(t){t.scale+=1}),t.push(n),n.fromOffset=t.getOffset(n.from),n.toOffset=t.getOffset(n.to)}else n.valid=!1}return r}function o(){this.stack=[],this.offset=new Map;for(let t of I)this.offset.set(t,0)}function i(t,e,r){j=new a(t,e),W=j.elementMap,C=j.display,X=j.displaySet;for(var n=new Set([0]),o=W.get(0);-1!=o.parent;)n.add(o.parent),o=W.get(o.parent);U=[0],H=new s(r,n,X,W),Y=H.validMessages,h()}function l(t){j.unfoldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),C.forEach(function(t){it=Math.max(it,t.height)});for(var a=0;a<t.children.length;a++){var r=t.children[a],s=W.get(r),n=p(s);n.attr("transform","translate("+t.x+", "+(t.y+ot)+")"),n.transition().attr("transform","translate("+s.x+", "+s.y+")"),d3.select("#baseLine"+r).transition().attr("transform","translate("+s.x+", "+s.y+")")}}(t);g(H.unfoldUpdateStatus(X,W)),c()}function f(t){j.foldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),it=Math.max(it,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),it=rt,C.forEach(function(t){it=Math.max(it,t.height)})}(t),H.unfoldUpdateStatus(X,W),g([]),c()}function d(t){for(var e=0;e<t.children.length;e++){var a=W.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function c(){for(var t=0,e=F;e<F+N&&!(e>=C.length);e++)t=Math.min(C[e].y,t);var a=parseInt(d3.select(".objects-layout").attr("transform").split(/,|\)/)[1]);void 0==i.prototype.top?(d3.select(".objects-layout").attr("transform","translate(0,"+(a-t)+")"),i.prototype.top=t):i.prototype.top!=t&&(d3.select(".objects-layout").attr("transform","translate(0,"+(a+i.prototype.top-t)+")"),i.prototype.top=t)}function h(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","mainthread-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function p(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,r=(_&&T+z<Y.length?z:Y.length)*ft+rt+ft/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",r).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var s=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?s.style("fill","yellow"):s.style("fill","white"),e.append("text").text(function(e){return t.displayName}).attr("transform","translate("+t.width/2+","+(t.height/2+st)+")").attr("text-anchor","middle"),e.attr("class","element").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){t.fold?l(t):function(t){var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(d(a))f(a),e.splice(e.length-1,1);else for(var r=0;r<a.children.length;r++){var s=W.get(a.children[r]);s.isGroup()&&(d(s)?f(s):e.push(s))}}}(t)}),e}function u(t){var e=W.get(t.from),a=W.get(t.to),r=e.x+e.width/2-lt/2+t.fromOffset*lt,s=t.position+dt,n=t.scale*ft-2*dt,o=a.x+a.width/2-lt/2+t.toOffset*lt,i=s+dt,l=n-2*dt;if(_){var f=F>0?C[F-1].x:C[0].x,d=F+N;d>=C.length&&(d=C.length-1);var c=C[d].x;r<f&&(r=f),o>c&&(o=c)}var h=W.get(t.from).x<W.get(t.to).x,p=d3.select(".messages-layout").append("g"),u=p.append("text").attr("class","message-text").text(function(e){return t.message});h?u.attr("transform","translate("+(r+nt)+","+s+")"):u.attr("transform","translate("+(r-lt)+","+s+")").attr("text-anchor","end"),p.append("line").attr("class","callLine").style("stroke","black").attr("x1",h?r+lt:r).attr("y1",i).attr("x2",h?o:o+lt).attr("y2",i).attr("marker-end","url(#end)"),p.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",h?o:o+lt).attr("y1",i+l).attr("x2",h?r+lt:r).attr("y2",i+l).attr("marker-end","url(#end)"),p.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:lt,height:l}).attr("transform","translate("+o+","+i+")").style("stroke","black").style("fill","#CCC"),p.attr("class","message").datum(t)}function g(t){for(let e of t)e.valid&&u(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=W.get(t.from),a=W.get(t.to),r=e.x+e.width/2-lt/2+t.fromOffset*lt,s=t.position+dt,n=t.scale*ft-2*dt,o=a.x+a.width/2-lt/2+t.toOffset*lt,i=s+dt,l=n-2*dt,f=W.get(t.from).x<W.get(t.to).x;f?d3.select(this).select(".message-text").transition().attr("transform","translate("+(r+nt)+","+s+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(r-lt)+","+s+")"),d3.select(this).select(".callLine").transition().attr("x1",f?r+lt:r).attr("y1",i).attr("x2",f?o:o+lt).attr("y2",i),d3.select(this).select(".callBackLine").transition().attr("x1",f?o:o+lt).attr("y1",i+l).attr("x2",f?r+lt:r).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:lt,height:l}).attr("transform","translate("+o+","+i+")"),d3.select(this).select(".message-click-active-block").transition().attr({x:-nt,y:-nt,width:2*nt+Math.abs(o-r),height:2*nt+l}).attr("transform","translate("+Math.min(r,o)+","+i+")")}else d3.select(this).remove()});var e=(_&&T+z<Y.length?z:Y.length)*ft+rt+ft/2;d3.selectAll(".baseLine").attr("y2",e),y()}function m(){for(let s of U){for(var t=W.get(s);!X.has(t.id)&&-1!=t.parent;)t=W.get(t.parent);var e=t.x+t.width/2-lt/2,a=.75*ft,r=Y.length*ft;d3.select(".mainthread-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:lt,height:r}).attr("transform","translate("+e+","+a+")").style("stroke","black").style("fill","#CCC")}}function y(){d3.selectAll(".mainThreadActiveBar").remove(),m()}function v(t,e,a){K=window.innerWidth,Q=window.innerHeight-100,at=1,q=-10,J=-10,d3.select("svg").remove(),(P=d3.select("#drawArea").append("svg").attr("width",K).attr("height",Q).call(d3.behavior.zoom().scaleExtent([.2,10]).on("zoom",function(){if(at!==d3.event.scale){var t=at/d3.event.scale;at=d3.event.scale,q=R-t*(R-q),J=Math.max(Z-t*(Z-J),2*V.top),P.attr("viewBox",q+" "+J+" "+K/at+" "+Q/at),x()}}))).on("mousedown",function(){et=!0,$=d3.mouse(this)[0],tt=d3.mouse(this)[1]}),P.on("mouseup",function(){et=!1,q=q-d3.mouse(this)[0]+$,J=Math.max(J-d3.mouse(this)[1]+tt,2*V.top),P.attr("viewBox",q+" "+J+" "+K/at+" "+Q/at),x()}),P.on("mousemove",function(){R=d3.mouse(this)[0],Z=d3.mouse(this)[1],et&&(q=q-d3.mouse(this)[0]+$,J=Math.max(J-d3.mouse(this)[1]+tt,2*V.top),P.attr("viewBox",q+" "+J+" "+K/at+" "+Q/at),x())}),P.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),(V=new i(t,e,a)).setDiagramSize(ct,ht),V.setDiagramDisplayHead(pt,ut),V.drawWindow()}function x(){if(-1!=V.getMiddleElementX()&&q>=V.getMiddleElementX()&&w(V.getMiddleElementIndex(),ut),pt>0&&q<=V.getHeadElementX()){(t=pt-ct/2)<0&&(t=0),w(t,ut)}if(-1!=V.getMiddleMessageY()&&J>=V.getMiddleMessageY()&&w(pt,V.getMiddleMessageIndex()),ut>0&&J<=V.getHeadMessageY()){var t=ut-ht/2;t<0&&(t=0),w(pt,t)}d3.select(".objects-layout").attr("transform","translate(0,"+(J-V.top)+")")}function w(t,e){V.clearAll(),pt=t,ut=e,V.setDiagramDisplayHead(t,e),V.drawWindow()}var M=40,b=10,k=20;e.prototype.isGroup=function(){return 0!=this.children.length};var L,S=20,E=[],O=[];a.prototype.getGroupFoldInfo=function(){var t=new Set;for(let e of O)e.isGroup()&&!e.fold&&t.add(e.id);return t},a.prototype.unfoldUpdateStatus=function(t){var e=E.get(t);if(e.fold){for(var a=e.children,s=10,n=O.indexOf(e)+1,o=0;o<a.length;o++){var i=E.get(a[o]);i.x=s+e.x,O.splice(n,0,i),n++,s+=i.width+S}for(var l=s-S+10-e.width;n<O.length;)O[n].x+=l,n++;e.width+=l,e.y-=10,e.height+=20,e.fold=!1;for(var f=e;-1!=f.parent;)(f=E.get(f.parent)).width+=l,f.height+=20,f.y-=10;r()}},a.prototype.foldUpdateStatus=function(t){var e=E.get(t);if(!e.fold){for(var a=e.children,s=0,n=0;n<a.length;n++){var o=E.get(a[n]);s=O.indexOf(o),O.splice(s,1)}for(var i=e.width-(10*e.displayName.length+2*S);s<O.length;)O[s].x-=i,s++;e.width-=i,e.y+=10,e.height-=20,e.fold=!0;for(var l=e;-1!=l.parent;)(l=E.get(l.parent)).width-=i,l.height-=20,l.y+=10;r()}};var A,B,G,I,D=80;s.prototype.foldUpdateStatus=function(t){for(let e of G)-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id);n()},s.prototype.unfoldUpdateStatus=function(t,e){for(let r of G){if(!t.has(r.from))for(r.from=B.get(r.id).from;!t.has(r.from);){if(-1==(a=e.get(r.from).parent))break;r.from=a}if(!t.has(r.to))for(r.to=B.get(r.id).to;!t.has(r.to);){var a=e.get(r.to).parent;if(-1==a)break;r.to=a}}return n()},o.prototype.push=function(t){this.stack.push(t),this.offset.has(t.to)?this.offset.set(t.to,this.offset.get(t.to)+1):this.offset.set(t.to,0)},o.prototype.pop=function(){var t=this.stack.pop(),e=this.offset.get(t.to)-1;return e<0?this.offset.delete(t.to):this.offset.set(t.to,e),t},o.prototype.peek=function(){return this.stack[this.stack.length-1]},o.prototype.hasActive=function(t){return this.offset.has(t)},o.prototype.getOffset=function(t){return this.offset.has(t)?this.offset.get(t):0};var j,H,U,C,W,X,Y;i.prototype.draw=function(){h();for(var t=0;t<C.length;t++)p(C[t]);m();for(let t of Y)u(t)},i.prototype.getMessages=function(){return Y},i.prototype.getElementSet=function(){return X},i.prototype.getElementMap=function(){return W};var N,z,F,T,_=!1;i.prototype.setDiagramSize=function(t,e){N=t,z=e,_=!0,this.setDiagramDisplayHead(0,0)},i.prototype.setDiagramDisplayHead=function(t,e){F=t,T=e},i.prototype.getMiddleElementIndex=function(){return F+N/2},i.prototype.getMiddleElementX=function(){var t=this.getMiddleElementIndex();return t<C.length?C[t].x:-1},i.prototype.getHeadElementX=function(){return C[F].x},i.prototype.getMiddleMessageIndex=function(){return T+z/2},i.prototype.getMiddleMessageY=function(){var t=this.getMiddleMessageIndex();return t<Y.length?Y[t].position:-1},i.prototype.getHeadMessageY=function(){return Y[T].position},i.prototype.getIndexByMessageId=function(t){for(var e=-1,a=-1,r=-1,s=-1,n=0;n<Y.length;n++)if(Y[n].id==t){a=n,s=Y[n].position;break}if(-1!=a)for(var o=0;o<C.length;o++)if(C[o].id==Y[a].from){e=o,r=C[o].x;break}return[e,a,r,s-60]},i.prototype.drawWindow=function(){for(t=F;t<F+N&&!(t>=C.length);t++)p(C[t]);c(),m();for(var t=T;t<z&&!(t>=Y.length);t++)u(Y[t])},i.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".mainthread-layout").remove(),d3.select(".baseline-layout").remove(),h()},i.prototype.getFoldInfo=function(){return j.getGroupFoldInfo()},i.prototype.updateWithoutAnimation=function(t){for(let e of C)if(t.has(e.id)){j.unfoldUpdateStatus(group.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").attr({width:e.width,height:e.height}),e==t?(d3.select(this).style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))}),C.forEach(function(t){it=Math.max(it,t.height)});for(var a=0;a<t.children.length;a++){var r=t.children[a],s=W.get(r),n=p(s);n.attr("transform","translate("+t.x+", "+(t.y+ot)+")"),n.attr("transform","translate("+s.x+", "+s.y+")"),d3.select("#baseLine"+r).attr("transform","translate("+s.x+", "+s.y+")")}}(group);!function(t){for(let e of t)e.valid&&u(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=W.get(t.from),a=W.get(t.to),r=e.x+e.width/2-lt/2+t.fromOffset*lt,s=t.position+dt,n=t.scale*ft-2*dt,o=a.x+a.width/2-lt/2+t.toOffset*lt,i=s+dt,l=n-2*dt,f=W.get(t.from).x<W.get(t.to).x;f?d3.select(this).select(".message-text").attr("transform","translate("+(r+nt)+","+s+")"):d3.select(this).select(".message-text").attr("transform","translate("+(r-lt)+","+s+")"),d3.select(this).select(".callLine").attr("x1",f?r+lt:r).attr("y1",i).attr("x2",f?o:o+lt).attr("y2",i),d3.select(this).select(".callBackLine").attr("x1",f?o:o+lt).attr("y1",i+l).attr("x2",f?r+lt:r).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").attr({x:0,y:0,width:lt,height:l}).attr("transform","translate("+o+","+i+")"),d3.select(this).select(".message-click-active-block").attr({x:-nt,y:-nt,width:2*nt+Math.abs(o-r),height:2*nt+l}).attr("transform","translate("+Math.min(r,o)+","+i+")")}else d3.select(this).remove()});var e=(_&&T+z<Y.length?z:Y.length)*ft+rt+ft;d3.selectAll(".baseLine").attr("y2",e),y()}(H.unfoldUpdateStatus(X,W))}};var P,V,q,J,K,Q,R,Z,$,tt,et,at,rt=40,st=4,nt=20,ot=10,it=rt,lt=10,ft=80,dt=ft/8,ct=252,ht=360,pt=0,ut=0;v.prototype.locate=function(t){var e=V.getIndexByMessageId(t);return-1!=e[0]&&-1!=e[1]&&(function(t,e){q=t,J=e,P.attr("viewBox",q+" "+J+" "+K/at+" "+Q/at)}(e[2],e[3]),x(),!0)},v.prototype.getMessages=function(){return V.getMessages()},v.prototype.getElementSet=function(){return V.getElementSet()},v.prototype.getElementMap=function(){return V.getElementMap()},t.SDController=i,t.SDViewer=v,Object.defineProperty(t,"__esModule",{value:!0})});