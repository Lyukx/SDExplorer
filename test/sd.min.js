!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.displayName=t.name,void 0!=t.type&&(this.displayName+=":"+t.type),this.parent=-1,this.children=[],this.fold=!0,this.x=0,this.y=0,this.height=E,this.width=this.displayName.length*L+2*S}function a(t,a){!function(t,a){B=new Map,G=[],t.forEach(function(t){var a=new e(t);B.set(a.id,a)}),a.forEach(function(a){var r=new e(a);r.children=a.objs,B.set(r.id,r),t=a.objs;for(var s=0;s<t.length;s++)B.get(t[s]).parent=a.id})}(t,a),B.forEach(function(t,e,a){-1==t.parent&&G.push(t)}),G.sort(function(t,e){var a=t.id,r=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(r=e.children[0]),a-r});for(var s=O,o=0;o<G.length;o++)G[o].x=s,s+=G[o].width+O;r(),this.display=G,this.elementMap=B,this.displaySet=A}function r(){A=new Set;for(let t of G)t.isGroup()&&!t.fold||A.add(t.id)}function s(t){this.from=t.from,this.to=t.to,this.message=t.message,this.id=t.id,this.count=t.count,this.valid=!1,this.scale=1,this.position=0,this.fromOffset=0,this.toOffset=0}function o(t,e,a,r){I=[],D=new Map,j=[];for(let e of t)j.push(new s(e)),D.set(e.id,{from:e.from,to:e.to});for(let t of j)if(-1!=t.to){for(;!a.has(t.from);){if(-1==(o=r.get(t.from).parent))break;t.from=o}for(;!a.has(t.to);){var o=r.get(t.to).parent;if(-1==o)break;t.to=o}}H=e,n(),this.validMessages=I}function n(){for(var t=[],e=new Set,a=0;a<j.length;a++){var r=j[a];r.isReturn()?e.has(r.id)&&t.push(r):r.to!=r.from&&-1!=r.from&&-1!=r.to?(t.push(r),e.add(r.id)):r.valid=!1}I=[];for(var s=[],o=new i,n=new Map,l=U/4,a=0;a<t.length;a++){var f=t[a];if(f.isReturn()){var d=n.get(f.id)[0],c=a-n.get(f.id)[1];l+=U/2,d.scale=(c+1)/2,o.pop()}else n.set(f.id,[f,a]),l+=U/2,f.position=l,o.push(f),f.fromOffset=o.getOffset(f.from),f.toOffset=o.getOffset(f.to),r.valid||s.push(r),f.valid=!0,I.push(f)}for(var h=t.length;!o.isEmpty();){var p=o.pop(),c=h-n.get(p.id)[1];l+=U/2,p.scale=(c+1)/2,h++}return s}function i(){this.stack=[],this.offset=new Map;for(let t of H)this.offset.set(t,0)}function l(t,e,r){C=new a(t,e),N=C.elementMap,Y=C.display,z=C.displaySet;for(var s=new Set([0]),n=N.get(0);-1!=n.parent;)s.add(n.parent),n=N.get(n.parent);X=[0],W=new o(r,s,z,N),F=W.validMessages,p()}function f(t){C.unfoldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),Y.forEach(function(t){ht=Math.max(ht,t.height)});for(var a=0;a<t.children.length;a++){var r=t.children[a],s=N.get(r),o=u(s);o.attr("transform","translate("+t.x+", "+(t.y+ct)+")"),o.transition().attr("transform","translate("+s.x+", "+s.y+")"),d3.select("#baseLine"+r).transition().attr("transform","translate("+s.x+", "+s.y+")")}}(t);m(W.unfoldUpdateStatus(z,N)),h()}function d(t){C.foldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),ht=Math.max(ht,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),ht=lt,Y.forEach(function(t){ht=Math.max(ht,t.height)})}(t),W.unfoldUpdateStatus(z,N),m([]),h()}function c(t){for(var e=0;e<t.children.length;e++){var a=N.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function h(){for(var t=0,e=_;e<_+R&&!(e>=Y.length);e++)t=Math.min(Y[e].y,t);var a=parseInt(d3.select(".objects-layout").attr("transform").split(/,|\)/)[1]);void 0==l.prototype.top?(d3.select(".objects-layout").attr("transform","translate(0,"+(a-t)+")"),l.prototype.top=t):l.prototype.top!=t&&(d3.select(".objects-layout").attr("transform","translate(0,"+(a+l.prototype.top-t)+")"),l.prototype.top=t)}function p(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","mainthread-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function u(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,r=(P&&q+T<F.length?T:F.length)*ut+lt+ut/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",r).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var s=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?s.style("fill","yellow"):s.style("fill","white"),e.append("text").text(function(e){return t.displayName}).attr("transform","translate("+t.width/2+","+(t.height/2+ft)+")").attr("text-anchor","middle"),e.attr("class","element").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){t.fold?f(t):function(t){var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(c(a))d(a),e.splice(e.length-1,1);else for(var r=0;r<a.children.length;r++){var s=N.get(a.children[r]);s.isGroup()&&(c(s)?d(s):e.push(s))}}}(t)}),e}function g(t){var e=N.get(t.from),a=N.get(t.to),r=e.x+e.width/2-pt/2+t.fromOffset*pt,s=t.position+gt,o=t.scale*ut-2*gt,n=a.x+a.width/2-pt/2+t.toOffset*pt,i=s+gt,l=o-2*gt;if(P){var f=_>0?Y[_-1].x:Y[0].x,d=_+R;d>=Y.length&&(d=Y.length-1);var c=Y[d].x;r<f&&(r=f),n>c&&(n=c)}var h=N.get(t.from).x<N.get(t.to).x,p=d3.select(".messages-layout").append("g"),u=p.append("text").attr("class","message-text").text(function(e){return t.message});h?u.attr("transform","translate("+(r+dt)+","+s+")"):u.attr("transform","translate("+(r-pt)+","+s+")").attr("text-anchor","end"),p.append("line").attr("class","callLine").style("stroke","black").attr("x1",h?r+pt:r).attr("y1",i).attr("x2",h?n:n+pt).attr("y2",i).attr("marker-end","url(#end)"),p.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",h?n:n+pt).attr("y1",i+l).attr("x2",h?r+pt:r).attr("y2",i+l).attr("marker-end","url(#end)"),p.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:pt,height:l}).attr("transform","translate("+n+","+i+")").style("stroke","black").style("fill","#CCC"),p.attr("class","message").datum(t)}function m(t){for(let e of t)e.valid&&g(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=N.get(t.from),a=N.get(t.to),r=e.x+e.width/2-pt/2+t.fromOffset*pt,s=t.position+gt,o=t.scale*ut-2*gt,n=a.x+a.width/2-pt/2+t.toOffset*pt,i=s+gt,l=o-2*gt,f=N.get(t.from).x<N.get(t.to).x;f?d3.select(this).select(".message-text").transition().attr("transform","translate("+(r+dt)+","+s+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(r-pt)+","+s+")"),d3.select(this).select(".callLine").transition().attr("x1",f?r+pt:r).attr("y1",i).attr("x2",f?n:n+pt).attr("y2",i),d3.select(this).select(".callBackLine").transition().attr("x1",f?n:n+pt).attr("y1",i+l).attr("x2",f?r+pt:r).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:pt,height:l}).attr("transform","translate("+n+","+i+")"),d3.select(this).select(".message-click-active-block").transition().attr({x:-dt,y:-dt,width:2*dt+Math.abs(n-r),height:2*dt+l}).attr("transform","translate("+Math.min(r,n)+","+i+")")}else d3.select(this).remove()});var e=(P&&q+T<F.length?T:F.length)*ut+lt+ut/2;d3.selectAll(".baseLine").attr("y2",e),v()}function y(){for(let s of X){for(var t=N.get(s);!z.has(t.id)&&-1!=t.parent;)t=N.get(t.parent);var e=t.x+t.width/2-pt/2,a=.75*ut,r=F.length*ut;d3.select(".mainthread-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:pt,height:r}).attr("transform","translate("+e+","+a+")").style("stroke","black").style("fill","#CCC")}}function v(){d3.selectAll(".mainThreadActiveBar").remove(),y()}function x(t,e,a){Z=window.innerWidth,$=window.innerHeight-100,ot=1,K=-10,Q=-10,d3.select("svg").remove(),(V=d3.select("#drawArea").append("svg").attr("width",Z).attr("height",$).call(d3.behavior.zoom().scaleExtent([.2,10]).on("zoom",function(){if(ot!==d3.event.scale){var t=ot/d3.event.scale;ot=d3.event.scale,K=tt-t*(tt-K),Q=Math.max(et-t*(et-Q),2*J.top),V.attr("viewBox",K+" "+Q+" "+Z/ot+" "+$/ot),w()}}))).on("mousedown",function(){st=!0,at=d3.mouse(this)[0],rt=d3.mouse(this)[1]}),V.on("mouseup",function(){st=!1,K=K-d3.mouse(this)[0]+at,Q=Math.max(Q-d3.mouse(this)[1]+rt,2*J.top),V.attr("viewBox",K+" "+Q+" "+Z/ot+" "+$/ot),w()}),V.on("mousemove",function(){tt=d3.mouse(this)[0],et=d3.mouse(this)[1],st&&(K=K-d3.mouse(this)[0]+at,Q=Math.max(Q-d3.mouse(this)[1]+rt,2*J.top),V.attr("viewBox",K+" "+Q+" "+Z/ot+" "+$/ot),w())}),V.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),(J=new l(t,e,a)).setDiagramSize(mt,yt),J.setDiagramDisplayHead(vt,xt),J.drawWindow(),nt=J.getElementSet(),it=J.getElementMap()}function w(){if(-1!=J.getMiddleElementX()&&K>=J.getMiddleElementX()&&b(J.getMiddleElementIndex(),xt),vt>0&&K<=J.getHeadElementX()){(t=vt-mt/2)<0&&(t=0),b(t,xt)}if(-1!=J.getMiddleMessageY()&&Q>=J.getMiddleMessageY()&&b(vt,J.getMiddleMessageIndex()),xt>0&&Q<=J.getHeadMessageY()){var t=xt-yt/2;t<0&&(t=0),b(vt,t)}k()}function M(t,e,a,r){vt=Math.max(t-mt/2,0),xt=Math.max(e-yt/2,0),b(vt,xt),K=a,Q=r,V.attr("viewBox",K+" "+Q+" "+Z/ot+" "+$/ot),k()}function b(t,e){J.clearAll(),vt=t,xt=e,J.setDiagramDisplayHead(t,e),J.drawWindow()}function k(){d3.select(".objects-layout").attr("transform","translate(0,"+(Q-J.top)+")"),d3.select(".baseline-layout").attr("transform","translate(0,"+(Q-J.top)+")")}var E=40,L=10,S=20;e.prototype.isGroup=function(){return 0!=this.children.length};var A,O=20,B=[],G=[];a.prototype.getGroupFoldInfo=function(){var t=new Set;for(let e of G)e.isGroup()&&!e.fold&&t.add(e.id);return t},a.prototype.unfoldUpdateStatus=function(t){var e=B.get(t);if(e.fold){for(var a=e.children,s=10,o=G.indexOf(e)+1,n=0;n<a.length;n++){var i=B.get(a[n]);i.x=s+e.x,G.splice(o,0,i),o++,s+=i.width+O}for(var l=s-O+10-e.width;o<G.length;)G[o].x+=l,o++;e.width+=l,e.y-=10,e.height+=20,e.fold=!1;for(var f=e;-1!=f.parent;)(f=B.get(f.parent)).width+=l,f.height+=20,f.y-=10;r()}},a.prototype.foldUpdateStatus=function(t){var e=B.get(t);if(!e.fold){for(var a=e.children,s=0,o=0;o<a.length;o++){var n=B.get(a[o]);s=G.indexOf(n),G.splice(s,1)}for(var i=e.width-(10*e.displayName.length+2*O);s<G.length;)G[s].x-=i,s++;e.width-=i,e.y+=10,e.height-=20,e.fold=!0;for(var l=e;-1!=l.parent;)(l=B.get(l.parent)).width-=i,l.height-=20,l.y+=10;r()}},s.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message},s.prototype.isReturn=function(){return-1==this.to&&0==this.message.length};var I,D,j,H,U=80;o.prototype.foldUpdateStatus=function(t){for(let e of j)-1!=e.to&&(-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id));n()},o.prototype.unfoldUpdateStatus=function(t,e){for(let r of j)if(-1!=r.to){if(!t.has(r.from))for(r.from=D.get(r.id).from;!t.has(r.from);){if(-1==(a=e.get(r.from).parent))break;r.from=a}if(!t.has(r.to))for(r.to=D.get(r.id).to;!t.has(r.to);){var a=e.get(r.to).parent;if(-1==a)break;r.to=a}}return n()},i.prototype.push=function(t){this.stack.push(t),this.offset.has(t.to)?this.offset.set(t.to,this.offset.get(t.to)+1):this.offset.set(t.to,0)},i.prototype.pop=function(){var t=this.stack.pop(),e=this.offset.get(t.to)-1;return e<0?this.offset.delete(t.to):this.offset.set(t.to,e),t},i.prototype.peek=function(){return this.stack[this.stack.length-1]},i.prototype.hasActive=function(t){return this.offset.has(t)},i.prototype.isEmpty=function(){return 0==this.stack.length},i.prototype.getOffset=function(t){return this.offset.has(t)?this.offset.get(t):0};var C,W,X,Y,N,z,F;l.prototype.draw=function(){p();for(var t=0;t<Y.length;t++)u(Y[t]);y();for(let t of F)g(t)},l.prototype.getMessages=function(){return F},l.prototype.getElementSet=function(){return z},l.prototype.getElements=function(){return Y},l.prototype.getElementMap=function(){return N};var R,T,_,q,P=!1;l.prototype.setDiagramSize=function(t,e){R=t,T=e,P=!0,this.setDiagramDisplayHead(0,0)},l.prototype.setDiagramDisplayHead=function(t,e){_=t,q=e},l.prototype.getMiddleElementIndex=function(){return _+R/2},l.prototype.getMiddleElementX=function(){var t=this.getMiddleElementIndex();return t<Y.length?Y[t].x:-1},l.prototype.getHeadElementX=function(){return Y[_].x},l.prototype.getMiddleMessageIndex=function(){return q+T/2},l.prototype.getMiddleMessageY=function(){var t=this.getMiddleMessageIndex();return t<F.length?F[t].position:-1},l.prototype.getHeadMessageY=function(){return F[q].position},l.prototype.getIndexByMessageId=function(t){for(var e=-1,a=-1,r=-1,s=-1,o=0;o<F.length;o++)if(F[o].id==t){a=o,s=F[o].position;break}if(-1!=a)for(var n=0;n<Y.length;n++)if(Y[n].id==F[a].from){e=n,r=Y[n].x;break}return[e,a,r,s-60]},l.prototype.drawWindow=function(){for(t=_;t<_+R&&!(t>=Y.length);t++)u(Y[t]);h(),y();for(var t=q;t<q+T&&!(t>=F.length);t++)g(F[t])},l.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".mainthread-layout").remove(),d3.select(".baseline-layout").remove(),p()},l.prototype.getFoldInfo=function(){return C.getGroupFoldInfo()},l.prototype.updateWithoutAnimation=function(t){for(let e of Y)if(t.has(e.id)){C.unfoldUpdateStatus(group.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").attr({width:e.width,height:e.height}),e==t?(d3.select(this).style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))}),Y.forEach(function(t){ht=Math.max(ht,t.height)});for(var a=0;a<t.children.length;a++){var r=t.children[a],s=N.get(r),o=u(s);o.attr("transform","translate("+t.x+", "+(t.y+ct)+")"),o.attr("transform","translate("+s.x+", "+s.y+")"),d3.select("#baseLine"+r).attr("transform","translate("+s.x+", "+s.y+")")}}(group);!function(t){for(let e of t)e.valid&&g(e);d3.selectAll(".message").each(function(t){if(t.valid){var e=N.get(t.from),a=N.get(t.to),r=e.x+e.width/2-pt/2+t.fromOffset*pt,s=t.position+gt,o=t.scale*ut-2*gt,n=a.x+a.width/2-pt/2+t.toOffset*pt,i=s+gt,l=o-2*gt,f=N.get(t.from).x<N.get(t.to).x;f?d3.select(this).select(".message-text").attr("transform","translate("+(r+dt)+","+s+")"):d3.select(this).select(".message-text").attr("transform","translate("+(r-pt)+","+s+")"),d3.select(this).select(".callLine").attr("x1",f?r+pt:r).attr("y1",i).attr("x2",f?n:n+pt).attr("y2",i),d3.select(this).select(".callBackLine").attr("x1",f?n:n+pt).attr("y1",i+l).attr("x2",f?r+pt:r).attr("y2",i+l),d3.select(this).select(".rightActiveBlock").attr({x:0,y:0,width:pt,height:l}).attr("transform","translate("+n+","+i+")"),d3.select(this).select(".message-click-active-block").attr({x:-dt,y:-dt,width:2*dt+Math.abs(n-r),height:2*dt+l}).attr("transform","translate("+Math.min(r,n)+","+i+")")}else d3.select(this).remove()});var e=(P&&q+T<F.length?T:F.length)*ut+lt+ut;d3.selectAll(".baseLine").attr("y2",e),v()}(W.unfoldUpdateStatus(z,N))}};var V,J,K,Q,Z,$,tt,et,at,rt,st,ot,nt,it,lt=40,ft=4,dt=20,ct=10,ht=lt,pt=10,ut=80,gt=ut/8,mt=252,yt=360,vt=0,xt=0;x.prototype.isMessageDisplayed=function(t){for(;!nt.has(t.from);){if(-1==(e=it.get(t.from).parent))break;t.from=e}for(;!nt.has(t.to);){var e=it.get(t.to).parent;if(-1==e)break;t.to=e}return!(t.from==t.to||-1==t.from||-1==t.to)},x.prototype.locate=function(t){var e=J.getIndexByMessageId(t);return-1!=e[0]&&-1!=e[1]&&(M(e[0],e[1],e[2],e[3]),!0)},x.prototype.getMessages=function(){return J.getMessages()},x.prototype.getElements=function(){return J.getElements()},x.prototype.getElementMap=function(){return J.getElementMap()},x.prototype.getContext=function(){return[vt,xt,K,Q]},x.prototype.resume=function(t){M(param[0],param[1],param[2],param[3])},t.SDController=l,t.SDViewer=x,Object.defineProperty(t,"__esModule",{value:!0})});