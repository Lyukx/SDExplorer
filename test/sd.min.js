!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.name=t.name,this.parent=-1,this.children=[],this.x=0,this.y=0,this.height=m,this.width=this.name.length*v+2*y,this.fold=!0}function a(t,a){var r=new Map;return t.forEach(function(t){t.name=t.name+":"+t.type;var a=new e(t);r.set(a.id,a)}),a.forEach(function(t){var a=new e(t);a.children=t.objs,r.set(a.id,a)}),a.forEach(function(e){t=e.objs;for(var a=0;a<t.length;a++){r.get(t[a]).parent=e.id}}),r}function r(t,e){w=a(t,e),w.forEach(function(t,e,a){-1==t.parent&&k.push(t)}),k.sort(function(t,e){var a=t.id,r=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(r=e.children[0]),a-r});for(var r=x,s=0;s<k.length;s++)k[s].x=r,r+=k[s].width+x;this.total=w,this.display=k}function s(t){this.from=t.from,this.to=t.to,this.message=t.message,this.callee=t.callee,this.id=-1,this.valid=!1,this.scale=1,this.position=0}function i(t,e){this.messages=[],this.origin=[],this.mainThreads=e;for(var a=0;a<t.length;a++){var r=new s(t[a]);r.id=a,this.messages.push(r),this.origin.push({from:r.from,to:r.to})}b=this.origin}function n(t,e,a){var s=new r(t,e);E=s,N=s.total,T=s.display;var n=new Set;n.add(0);for(var o=N.get(0);-1!=o.parent;)n.add(o.parent),o=N.get(o.parent);M=n;var l=new Set;T.forEach(function(t){t.isGroup()&&!t.fold||l.add(t.id)});var h=new i(a,n);h.updateMessageInit(N,l),h.updateStatus(),F=h.messages,I=h.origin,S=h}function o(){var t=S.validMessageNum*B,e=new Set;T.forEach(function(t){t.isGroup()&&!t.fold||e.add(t.id)}),M.forEach(function(a){if(e.has(a)){var r=N.get(a),s=r.x+r.width/2-j/2,i=B;d3.select(".mainThreadActiveBar").attr({x:0,y:0,width:j,height:t}).attr("transform","translate("+s+","+i+")")}})}function l(t){E.unfoldUpdateStatus(t.id);var e=new Set;T.forEach(function(t){t.isGroup()&&!t.fold||e.add(t.id)}),S.updateMessageOnUnfold(N,e),g(t,S.updateStatus()),o()}function h(t){E.foldUpdateStatus(t.id),S.updateMessageOnFold(t),S.updateStatus(),p(t),o()}function d(t){var e=N.get(t.from),a=N.get(t.to),r=e.x+e.width/2-j/2,s=t.position+C,i=t.scale*B-2*C,n=a.x+a.width/2-j/2,o=s+C,l=i-2*C,h=N.get(t.from).x<N.get(t.to).x,d=d3.select(".messages-layout").append("g");h?d.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(r+A)+","+s+")"):d.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(r-j)+","+s+")").attr("text-anchor","end"),d.append("line").attr("class","callLine").style("stroke","black").attr("x1",h?r+j:r).attr("y1",o).attr("x2",h?n:n+j).attr("y2",o).attr("marker-end","url(#end)"),d.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",h?n:n+j).attr("y1",o+l).attr("x2",h?r+j:r).attr("y2",o+l).attr("marker-end","url(#end)"),d.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:j,height:l}).attr("transform","translate("+n+","+o+")").style("stroke","black").style("fill","#CCC"),d.attr("class","message").datum(t)}function c(t){for(var e=0;e<t.children.length;e++){var a=N.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function f(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,r=(S.validMessageNum+1)*B+U/2+G/2;e.append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",r).style("stroke","black").style("stroke-dasharray","2,2,2");var s=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?s.style("fill","yellow"):s.style("fill","white"),e.append("text").text(function(e){return t.name}).attr("transform","translate("+t.width/2+","+(t.height/2+O)+")").attr("text-anchor","middle"),e.attr("class","element-rectangle").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){if(t.fold)l(t);else{var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(c(a))h(a),e.splice(e.length-1,1);else for(var r=0;r<a.children.length;r++){var s=N.get(a.children[r]);s.isGroup()&&(c(s)?h(s):e.push(s))}}}}),e}function u(){d3.selectAll(".message").each(function(t){if(!t.valid)return void d3.select(this).remove();var e=N.get(t.from),a=N.get(t.to),r=e.x+e.width/2-j/2,s=t.position+C,i=t.scale*B-2*C,n=a.x+a.width/2-j/2,o=s+C,l=i-2*C,h=N.get(t.from).x<N.get(t.to).x;h?d3.select(this).select(".message-text").transition().attr("transform","translate("+(r+A)+","+s+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(r-j)+","+s+")"),d3.select(this).select(".callLine").transition().attr("x1",h?r+j:r).attr("y1",o).attr("x2",h?n:n+j).attr("y2",o),d3.select(this).select(".callBackLine").transition().attr("x1",h?n:n+j).attr("y1",o+l).attr("x2",h?r+j:r).attr("y2",o+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:j,height:l}).attr("transform","translate("+n+","+o+")")}),d3.selectAll(".baseLine").attr("y2",(S.validMessageNum+1)*B+U/2+G/2)}function g(t,e){d3.selectAll(".element-rectangle").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select(this).select(".baseLine").style("opacity",0)):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")}),T.forEach(function(t){U=Math.max(U,t.height)});for(var a=0;a<t.children.length;a++){var r=t.children[a],s=N.get(r),i=f(s);i.attr("transform","translate("+t.x+", "+(t.y+L)+")"),i.transition().attr("transform","translate("+s.x+", "+s.y+")")}e.forEach(function(t){d(t)}),u()}function p(t){d3.selectAll(".element-rectangle").each(function(e){-1!=t.children.indexOf(e.id)?d3.select(this).remove():e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),U=Math.max(U,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select(this).select(".baseLine").style("opacity",1)):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")}),U=G,T.forEach(function(t){U=Math.max(U,t.height)}),u()}var m=40,v=10,y=20;e.prototype.isGroup=function(){return 0!=this.children.length};var x=20,w=[],k=[];r.prototype.unfoldUpdateStatus=function(t){var e=w.get(t);if(e.fold){for(var a=e.children,r=10,s=k.indexOf(e)+1,i=0;i<a.length;i++){var n=w.get(a[i]);n.x=r+e.x,k.splice(s,0,n),s++,r+=n.width+x}for(var o=r-x+10-e.width;s<k.length;)k[s].x+=o,s++;e.width+=o,e.y-=10,e.height+=20,e.fold=!1;for(var l=e;-1!=l.parent;)l=w.get(l.parent),l.width+=o,l.height+=20,l.y-=10}},r.prototype.foldUpdateStatus=function(t){var e=w.get(t);if(!e.fold){for(var a=e.children,r=0,s=0;s<a.length;s++){var i=w.get(a[s]);r=k.indexOf(i),k.splice(r,1)}for(var n=e.width-(10*e.name.length+2*x);r<k.length;)k[r].x-=n,r++;e.width-=n,e.y+=10,e.height-=20,e.fold=!0;for(var o=e;-1!=o.parent;)o=w.get(o.parent),o.width-=n,o.height-=20,o.y+=10}},s.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message&&this.callee==t.callee&&this.scale==t.scale};var b=[];i.prototype.updateMessageInit=function(t,e){this.messages.forEach(function(a){for(;!e.has(a.from);){var r=t.get(a.from).parent;if(a.from=r,-1==r)break}for(;!e.has(a.to);){var r=t.get(a.to).parent;if(a.to=r,-1==r)break}})},i.prototype.updateMessageOnFold=function(t){this.messages.forEach(function(e){-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id)})},i.prototype.updateMessageOnUnfold=function(t,e){this.messages.forEach(function(a){if(!e.has(a.from))for(a.from=b[a.id].from;!e.has(a.from);){var r=t.get(a.from).parent;if(a.from=r,-1==r)break}if(!e.has(a.to))for(a.to=b[a.id].to;!e.has(a.to);){var r=t.get(a.to).parent;if(a.to=r,-1==r)break}})},i.prototype.updateStatus=function(){for(var t,e=new Set,a=0,r=0,s=[],i=0,n=0;n<this.messages.length;n++){var o=this.messages[n];if(o.to==o.from||-1==o.from||-1==o.to)o.valid=!1;else if(this.mainThreads.has(o.from))e.clear(),e.add(o.to),o.valid||s.push(o),o.valid=!0,o.scale=1,a+=80+i,i=0,o.position=a,t=o.id,r++;else if(e.has(o.from)){e.add(o.to),o.valid||s.push(o),o.valid=!0,o.scale=1;var l=this.messages[n-1];if(o.from==l.to)a+=40,o.position=a,i+=40;else{for(var h=0,d=l;d.from!=o.from;)h+=40,i-=40,d=this.messages[d.id-1];a+=80+h,o.position=a}for(var c=t;c<n&&(this.messages[c].scale+=1,this.messages[c].to!=o.from);c++);r++}else o.valid=!1}return this.validMessageNum=r,s};var E,M,S,G=40,O=4,A=20,L=10,j=10,B=80,C=B/8,U=G,N=[],T=[],F=[],I=[];n.prototype.drawAll=function(){d3.select("svg").append("g").attr("class","objects-layout"),d3.select("svg").append("g").attr("class","messages-layout"),T.forEach(function(t){f(t)});var t=S.validMessageNum*B;M.forEach(function(e){var a=N.get(e),r=a.x+a.width/2-j/2,s=B;d3.select(".messages-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:j,height:t}).attr("transform","translate("+r+","+s+")").style("stroke","black").style("fill","#CCC")}),F.forEach(function(t){t.valid&&d(t)})},t.SDViewer=n,Object.defineProperty(t,"__esModule",{value:!0})});