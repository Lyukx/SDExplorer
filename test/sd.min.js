!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.name=t.name,this.parent=-1,this.children=[],this.x=0,this.y=0,this.height=O,this.width=this.name.length*S+2*L,this.fold=!0}function a(t,a){var s=new Map;return t.forEach(function(t){t.name=t.name+":"+t.type;var a=new e(t);s.set(a.id,a)}),a.forEach(function(t){var a=new e(t);a.children=t.objs,s.set(a.id,a)}),a.forEach(function(e){t=e.objs;for(var a=0;a<t.length;a++){s.get(t[a]).parent=e.id}}),s}function s(t,e){A=a(t,e),A.forEach(function(t,e,a){-1==t.parent&&B.push(t)}),B.sort(function(t,e){var a=t.id,s=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(s=e.children[0]),a-s});for(var s=D,r=0;r<B.length;r++)B[r].x=s,s+=B[r].width+D;this.total=A,this.display=B}function r(t){this.from=t.from,this.to=t.to,this.message=t.message,this.callee=t.callee,this.id=-1,this.valid=!1,this.scale=1,this.position=0}function i(t,e){this.messages=[],this.origin=[],this.mainThreads=e;for(var a=0;a<t.length;a++){var s=new r(t[a]);s.id=a,this.messages.push(s),this.origin.push({from:s.from,to:s.to})}G=this.origin,this.firstValidMsg=this.messages[0],this.lastValidMsg=this.messages[this.messages.length-1],this.validMessages=this.messages}function n(t){return t[t.length-1]}function o(t,e,a){var r=new s(t,e);C=r,Z=r.total,$=r.display;var n=new Set;n.add(0);for(var o=Z.get(0);-1!=o.parent;)n.add(o.parent),o=Z.get(o.parent);I=n;var l=new Set;$.forEach(function(t){t.isGroup()&&!t.fold||l.add(t.id)});var h=new i(a,n);h.updateMessageInit(Z,l),h.updateStatus(),tt=h.validMessages,et=h.origin,T=h,d(),H=!1,this.display=$,this.messages=tt,this.total=Z}function l(){for(var t=0,e=N;e<N+V&&!(e>=$.length);e++)t=Math.min($[e].y,t);var a=parseInt(d3.select(".objects-layout").attr("transform").split(/,|\)/)[1]);void 0==o.prototype.top?(d3.select(".objects-layout").attr("transform","translate(0,"+(a-t)+")"),o.prototype.top=t):o.prototype.top!=t&&(d3.select(".objects-layout").attr("transform","translate(0,"+(a+o.prototype.top-t)+")"),o.prototype.top=t)}function d(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function h(){var t=T.lastValidMsg,e=T.firstValidMsg,a=t.position-e.position+J+4*K;I.forEach(function(t){var s=Z.get(t),r=s.x+s.width/2-q/2,i=e.position;d3.select(".messages-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:q,height:a}).attr("transform","translate("+r+","+i+")").style("stroke","black").style("fill","#CCC")})}function c(){var t=T.lastValidMsg,e=T.firstValidMsg,a=t.position-e.position+J+4*K,s=new Set;$.forEach(function(t){t.isGroup()&&!t.fold||s.add(t.id)}),I.forEach(function(t){if(s.has(t)){var r=Z.get(t),i=r.x+r.width/2-q/2,n=e.position;d3.select(".mainThreadActiveBar").attr({x:0,y:0,width:q,height:a}).attr("transform","translate("+i+","+n+")")}})}function f(t){C.unfoldUpdateStatus(t.id);var e=new Set;$.forEach(function(t){t.isGroup()&&!t.fold||e.add(t.id)}),T.updateMessageOnUnfold(Z,e),x(t,T.updateStatus()),c()}function p(t){C.foldUpdateStatus(t.id),T.updateMessageOnFold(t),T.updateStatus(),w(t),c()}function g(t){var e=Z.get(t.from),a=Z.get(t.to),s=e.x+e.width/2-q/2,r=t.position+K,i=t.scale*J-2*K,n=a.x+a.width/2-q/2,o=r+K,l=i-2*K;if(H){var d=N>0?$[N-1].x:$[0].x,h=N+V;h>=$.length&&(h=$.length-1);var c=$[h].x;s<d&&(s=d),n>c&&(n=c)}var f=Z.get(t.from).x<Z.get(t.to).x,p=d3.select(".messages-layout").append("g");f?p.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s+W)+","+r+")"):p.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s-q)+","+r+")").attr("text-anchor","end"),p.append("line").attr("class","callLine").style("stroke","black").attr("x1",f?s+q:s).attr("y1",o).attr("x2",f?n:n+q).attr("y2",o).attr("marker-end","url(#end)"),p.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",f?n:n+q).attr("y1",o+l).attr("x2",f?s+q:s).attr("y2",o+l).attr("marker-end","url(#end)"),p.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:q,height:l}).attr("transform","translate("+n+","+o+")").style("stroke","black").style("fill","#CCC"),p.append("rect").attr("class","message-click-active-block").attr({x:-W,y:-W,width:2*W+Math.abs(n-s),height:2*W+l}).attr("transform","translate("+Math.min(s,n)+","+o+")").style("fill","#99ccff").style("fill-opacity","0").datum(t.id),p.attr("class","message").datum(t).on("click",function(e){var a=d3.select(this).select(".message-click-active-block");if(void 0!=X)if(X.style("fill-opacity","0"),X.datum()!=a.datum()){a.style("fill-opacity","0.4"),X=a;var s=d3.mouse(this)[0],r=d3.mouse(this)[1];d3.select(".hint-box").remove(),u(t.from,t.to,t.message,s,r)}else X=void 0,d3.select(".hint-box").remove();else{a.style("fill-opacity","0.4"),X=a;var s=d3.mouse(this)[0],r=d3.mouse(this)[1];u(t.from,t.to,t.message,s,r)}})}function u(t,e,a,s,r){var i=d3.select("svg").append("g").attr("class","hint-box"),n=Z.get(t).name,o=Z.get(e).name,l=1,d=d3.select("svg");if(null!=d[0][0]){d=d.attr("viewBox");var h=window.innerWidth;l=d.split(" ")[2]/h}var c=(Math.max(n.length,o.length,a.length)+8)*F+2*W;i.append("rect").attr({x:0,y:0,width:c,height:Q}).style("fill","#FEF8DE").style("stroke","black"),i.append("text").text(function(t){return"Caller: "+n}).attr("transform","translate("+W+","+(Q/6+P)+")").style("font-family","Courier New"),i.append("text").text(function(t){return"Callee: "+o}).attr("transform","translate("+W+","+(Q/2+P)+")").style("font-family","Courier New"),i.append("text").text(function(t){return"Method: "+a}).attr("transform","translate("+W+","+(Q/6*5+P)+")").style("font-family","Courier New"),i.attr("transform","translate("+s+","+r+") scale("+l+")")}function m(t){for(var e=0;e<t.children.length;e++){var a=Z.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function v(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,s=(H&&U+Y<tt.length?Y:T.validMessageNum)+1,r=tt[U].position-80,i=r+s*J+R/2+z/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",a).attr("y1",r).attr("x2",a).attr("y2",i).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var n=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?n.style("fill","yellow"):n.style("fill","white"),e.append("text").text(function(e){return t.name}).attr("transform","translate("+t.width/2+","+(t.height/2+P)+")").attr("text-anchor","middle"),e.attr("class","element-rectangle").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){if(t.fold)f(t);else{var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(m(a))p(a),e.splice(e.length-1,1);else for(var s=0;s<a.children.length;s++){var r=Z.get(a.children[s]);r.isGroup()&&(m(r)?p(r):e.push(r))}}}}),e}function y(){d3.selectAll(".message").each(function(t){if(!t.valid)return void d3.select(this).remove();var e=Z.get(t.from),a=Z.get(t.to),s=e.x+e.width/2-q/2,r=t.position+K,i=t.scale*J-2*K,n=a.x+a.width/2-q/2,o=r+K,l=i-2*K,d=Z.get(t.from).x<Z.get(t.to).x;d?d3.select(this).select(".message-text").transition().attr("transform","translate("+(s+W)+","+r+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(s-q)+","+r+")"),d3.select(this).select(".callLine").transition().attr("x1",d?s+q:s).attr("y1",o).attr("x2",d?n:n+q).attr("y2",o),d3.select(this).select(".callBackLine").transition().attr("x1",d?n:n+q).attr("y1",o+l).attr("x2",d?s+q:s).attr("y2",o+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:q,height:l}).attr("transform","translate("+n+","+o+")"),d3.select(this).select(".message-click-active-block").transition().attr({x:-W,y:-W,width:2*W+Math.abs(n-s),height:2*W+l}).attr("transform","translate("+Math.min(s,n)+","+o+")")});var t=(H&&U+Y<tt.length?Y:T.validMessageNum)+1,e=t*J+R/2+z/2;d3.selectAll(".baseLine").attr("y2",e)}function x(t,e){d3.selectAll(".element-rectangle").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),$.forEach(function(t){R=Math.max(R,t.height)});for(var a=0;a<t.children.length;a++){var s=t.children[a],r=Z.get(s),i=v(r);i.attr("transform","translate("+t.x+", "+(t.y+_)+")"),i.transition().attr("transform","translate("+r.x+", "+r.y+")"),d3.select("#baseLine"+s).transition().attr("transform","translate("+r.x+", "+r.y+")")}e.forEach(function(t){g(t)}),y(),l()}function w(t){d3.selectAll(".element-rectangle").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),R=Math.max(R,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),R=z,$.forEach(function(t){R=Math.max(R,t.height)}),y(),l()}function M(t,e,a){E(),st=new o(t,e,a),st.setDiagramDisplaySize(lt,dt),st.setDiagramDisplayHead(nt,ot),st.drawPart()}function b(){-1!=st.getMiddleObjX()&&it>=st.getMiddleObjX()&&k(st.getMiddleObjIndex(),ot),nt>0&&it<=st.getHeadObjX()&&k(nt-lt/2,ot),-1!=st.getMiddleMsgY()&&rt>=st.getMiddleMsgY()&&k(nt,st.getMiddleMsgIndex()),ot>0&&rt<=st.getHeadMsgY()&&k(nt,ot-dt/2),j()}function k(t,e){st.clearAll(),nt=t,ot=e,st.setDiagramDisplayHead(t,e),st.drawPart()}function j(){d3.select(".objects-layout").attr("transform","translate(0,"+(rt-st.getTopY())+")")}function E(){var t,e,a,s,r,i=window.innerWidth,n=window.innerHeight,o=1;it=-10,rt=-10,at=d3.select("#drawArea").append("svg").attr("width",i).attr("height",n).call(d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",function(){if(o!==d3.event.scale){var a=o/d3.event.scale;o=d3.event.scale,it=t-a*(t-it),rt=Math.max(e-a*(e-rt),2*st.getTopY()),at.attr("viewBox",it+" "+rt+" "+i/o+" "+n/o);var s=d3.select(".hint-box");if(null!=s[0][0]){var r=s.attr("transform").split(" ");s.attr("transform",r[0]+" scale("+1/o+")")}b()}})),at.on("mousedown",function(){r=!0,a=d3.mouse(this)[0],s=d3.mouse(this)[1]}),at.on("mouseup",function(){r=!1,it=it-d3.mouse(this)[0]+a,rt=Math.max(rt-d3.mouse(this)[1]+s,2*st.getTopY()),at.attr("viewBox",it+" "+rt+" "+i/o+" "+n/o),b()}),at.on("mousemove",function(){t=d3.mouse(this)[0],e=d3.mouse(this)[1],r&&(it=it-d3.mouse(this)[0]+a,rt=Math.max(rt-d3.mouse(this)[1]+s,2*st.getTopY()),at.attr("viewBox",it+" "+rt+" "+i/o+" "+n/o),b())}),at.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5")}var O=40,S=10,L=20;e.prototype.isGroup=function(){return 0!=this.children.length};var D=20,A=[],B=[];s.prototype.unfoldUpdateStatus=function(t){var e=A.get(t);if(e.fold){for(var a=e.children,s=10,r=B.indexOf(e)+1,i=0;i<a.length;i++){var n=A.get(a[i]);n.x=s+e.x,B.splice(r,0,n),r++,s+=n.width+D}for(var o=s-D+10-e.width;r<B.length;)B[r].x+=o,r++;e.width+=o,e.y-=10,e.height+=20,e.fold=!1;for(var l=e;-1!=l.parent;)l=A.get(l.parent),l.width+=o,l.height+=20,l.y-=10}},s.prototype.foldUpdateStatus=function(t){var e=A.get(t);if(!e.fold){for(var a=e.children,s=0,r=0;r<a.length;r++){var i=A.get(a[r]);s=B.indexOf(i),B.splice(s,1)}for(var n=e.width-(10*e.name.length+2*D);s<B.length;)B[s].x-=n,s++;e.width-=n,e.y+=10,e.height-=20,e.fold=!0;for(var o=e;-1!=o.parent;)o=A.get(o.parent),o.width-=n,o.height-=20,o.y+=10}},r.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message&&this.callee==t.callee&&this.scale==t.scale};var G=[];i.prototype.updateMessageInit=function(t,e){this.messages.forEach(function(a){for(;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}for(;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},i.prototype.updateMessageOnFold=function(t){this.messages.forEach(function(e){-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id)})},i.prototype.updateMessageOnUnfold=function(t,e){this.messages.forEach(function(a){if(!e.has(a.from))for(a.from=G[a.id].from;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}if(!e.has(a.to))for(a.to=G[a.id].to;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},i.prototype.updateStatus=function(){var t=new Set,e=[],a=20,s=0,r=[],i=0;this.validMessages=[];for(var o,l=0;l<this.messages.length;l++){var d=this.messages[l];if(d.to==d.from||-1==d.from||-1==d.to)d.valid=!1;else if(this.mainThreads.has(d.from))a+=80*(e.length+1)/2,d.position=a,e=[],e.push(d),t.clear(),t.add(d.to),d.valid||r.push(d),d.valid=!0,d.scale=1,s++,this.validMessages.push(d),o=d;else if(t.has(d.from)){d.valid||r.push(d),d.valid=!0,d.scale=1,s++,this.validMessages.push(d);for(var i=0;n(e).to!=d.from;){var h=e.pop();t.delete(h),i+=1}a+=80*(i+1)/2,d.position=a,e.forEach(function(t){t.scale+=1}),e.push(d),t.add(d.to)}else d.valid=!1}for(var c=null,l=this.messages.length-1;l>=0;l--){var d=this.messages[l];if(d.valid){o=d;break}}for(var l=0;l<this.messages.length;l++){var d=this.messages[l];if(d.valid){c=d;break}}return this.firstValidMsg=c,this.lastValidMsg=o,this.validMessageNum=s,r};var C,I,T,V,Y,H,N,U,X,z=40,F=10,P=4,W=20,_=10,q=10,J=80,K=J/8,Q=90,R=z,Z=[],$=[],tt=[],et=[];o.prototype.setDiagramDisplaySize=function(t,e){V=t,Y=e,H=!0,this.setDiagramDisplayHead(0,0)},o.prototype.setDiagramDisplayHead=function(t,e){N=t,U=e},o.prototype.getMiddleObjX=function(){return this.getMiddleObjIndex()<$.length?$[this.getMiddleObjIndex()].x:-1},o.prototype.getMiddleObjIndex=function(){return N+V/2},o.prototype.getHeadObjX=function(){return $[N].x},o.prototype.getMiddleMsgY=function(){return this.getMiddleMsgIndex()<tt.length?tt[this.getMiddleMsgIndex()].position:-1},o.prototype.getMiddleMsgIndex=function(){return U+Y/2},o.prototype.getHeadMsgY=function(){return tt[U].position},o.prototype.getTopY=function(){return this.top},o.prototype.drawAll=function(){$.forEach(function(t){v(t)}),l(),h(),tt.forEach(function(t){g(t)})},o.prototype.drawPart=function(){for(var t=N;t<N+V&&!(t>=$.length);t++)v($[t]);h();for(var t=U;t<U+Y&&!(t>=tt.length);t++)g(tt[t]);l()},o.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),d()};var at,st,rt,it,nt=0,ot=0,lt=126,dt=180;M.prototype.moveToObject=function(t){var e=st.total.get(t);console.log(e);var a=st.display.indexOf(e);if(console.log("Valid: "+(-1!=a)),-1!=a){nt=a,k(nt,ot);var s=e.x,r=d3.select("svg").attr("viewBox").split(" ");d3.select("svg").attr("viewBox",s+" "+r[1]+" "+r[2]+" "+r[3])}},M.prototype.moveToMessage=function(t){console.log(st.messages)},t.SDViewer=o,t.SVG=M,Object.defineProperty(t,"__esModule",{value:!0})});