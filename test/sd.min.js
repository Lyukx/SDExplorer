!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.name=t.name,this.parent=-1,this.children=[],this.x=0,this.y=0,this.height=u,this.width=this.name.length*g+2*m,this.fold=!0}function r(t,r){var a=new Map;return t.forEach(function(t){t.name=t.name+":"+t.type;var r=new e(t);a.set(r.id,r)}),r.forEach(function(t){var r=new e(t);r.children=t.objs,a.set(r.id,r)}),r.forEach(function(e){t=e.objs;for(var r=0;r<t.length;r++){a.get(t[r]).parent=e.id}}),a}function a(t,e){v=r(t,e),v.forEach(function(t,e,r){-1==t.parent&&x.push(t)}),x.sort(function(t,e){var r=t.id,a=e.id;return t.isGroup()&&(r=t.children[0]),e.isGroup()&&(a=e.children[0]),r-a});for(var a=y,i=0;i<x.length;i++)x[i].x=a,a+=x[i].width+y;this.total=v,this.display=x}function i(t){this.from=t.from,this.to=t.to,this.message=t.message,this.callee=t.callee,this.id=-1,this.valid=!1,this.scale=1,this.position=0}function s(t,e){this.messages=[],this.origin=[],this.mainThreads=e;for(var r=0;r<t.length;r++){var a=new i(t[r]);a.id=r,this.messages.push(a),this.origin.push({from:a.from,to:a.to})}this.updateStatus()}function n(t,e,r){var i=new a(t,e);w=i,M=i.total,j=i.display;var n=new Set;n.add(0),k=n;var o=new s(r,n);B=o.messages,O=o.origin,b=o}function o(t){w.unfoldUpdateStatus(t.id),f(t)}function l(t){w.foldUpdateStatus(t.id),p(t)}function h(t){var e=M.get(t.from),r=M.get(t.to),a=e.x+e.width/2-S/2,i=t.position+A,s=t.scale*E-2*A,n=r.x+r.width/2-S/2,o=i+A,l=s-2*A,h=d3.select("svg").append("g");k.has(t.from)||h.append("rect").attr("class","leftActiveBlock").attr({x:0,y:0,width:S,height:s}).attr("transform","translate("+a+","+i+")").style("stroke","black").style("fill","#CCC"),h.append("line").attr("class","callLine").style("stroke","black").attr("x1",t.from<t.to?a+S:a).attr("y1",o).attr("x2",t.from<t.to?n:n+S).attr("y2",o).attr("marker-end","url(#end)"),h.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",t.from<t.to?n:n+S).attr("y1",o+l).attr("x2",t.from<t.to?a+S:a).attr("y2",o+l).attr("marker-end","url(#end)"),h.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:S,height:l}).attr("transform","translate("+n+","+o+")").style("stroke","black").style("fill","#CCC")}function d(t){for(var e=0;e<t.children.length;e++){var r=M.get(t.children[e]);if(r.isGroup()&&!r.fold)return!1}return!0}function c(t){var e=d3.select("svg").append("g"),r=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?r.style("fill","yellow"):r.style("fill","white"),e.append("text").text(function(e){return t.name}).attr("transform","translate("+t.width/2+","+(t.height/2+G)+")").attr("text-anchor","middle"),e.attr("class","element-rectangle").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){if(t.fold)o(t);else{var e=[];for(e.push(t);0!=e.length;){var r=e[e.length-1];if(d(r))l(r),e.splice(e.length-1,1);else for(var a=0;a<r.children.length;a++){var i=M.get(r.children[a]);i.isGroup()&&(d(i)?l(i):e.push(i))}}}}),e}function f(t){d3.selectAll(".element-rectangle").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")});for(var e=0;e<t.children.length;e++){var r=t.children[e],a=M.get(r),i=c(a);i.attr("transform","translate("+t.x+", "+(t.y+C)+")"),i.transition().attr("transform","translate("+a.x+", "+a.y+")")}}function p(t){d3.selectAll(".element-rectangle").each(function(e){-1!=t.children.indexOf(e.id)?d3.select(this).remove():e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")})}var u=40,g=10,m=20;e.prototype.isGroup=function(){return 0!=this.children.length};var y=20,v=[],x=[];a.prototype.unfoldUpdateStatus=function(t){var e=v.get(t);if(e.fold){for(var r=e.children,a=10,i=x.indexOf(e)+1,s=0;s<r.length;s++){var n=v.get(r[s]);n.x=a+e.x,x.splice(i,0,n),i++,a+=n.width+y}for(var o=a-y+10-e.width;i<x.length;)x[i].x+=o,i++;e.width+=o,e.y-=10,e.height+=20,e.fold=!1;for(var l=e;-1!=l.parent;)l=v.get(l.parent),l.width+=o,l.height+=20,l.y-=10}},a.prototype.foldUpdateStatus=function(t){var e=v.get(t);if(!e.fold){for(var r=e.children,a=0,i=0;i<r.length;i++){var s=v.get(r[i]);a=x.indexOf(s),x.splice(a,1)}for(var n=e.width-(10*e.name.length+2*y);a<x.length;)x[a].x-=n,a++;e.width-=n,e.y+=10,e.height-=20,e.fold=!0;for(var o=e;-1!=o.parent;)o=v.get(o.parent),o.width-=n,o.height-=20,o.y+=10}},i.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message&&this.callee==t.callee&&this.scale==t.scale};s.prototype.updateStatus=function(){for(var t,e=new Set,r=0,a=0,i=0;i<this.messages.length;i++){var s=this.messages[i];if(this.mainThreads.has(s.from))e.clear(),e.add(s.to),s.valid=!0,s.scale=1,r+=80,s.position=r,t=s.id,a++;else if(e.has(s.from)){e.add(s.to),s.valid=!0,s.scale=1;var n=this.messages[i-1];s.from==n.to?(r+=40,s.position=r,r+=40):(r+=80,s.position=r);for(var o=t;o<i&&(this.messages[o].scale+=1,this.messages[o].to!=s.from);o++);a++}else s.valid=!1}this.validMessageNum=a};var w,k,b,G=4,C=10,S=10,E=80,A=E/8,M=[],j=[],B=[],O=[];n.prototype.drawAll=function(){j.forEach(function(t){if(!t.isGroup()||t.fold){var e=t.x+t.width/2,r=t.y,a=r+(b.validMessageNum+1)*E;d3.select("svg").append("line").attr("x1",e).attr("y1",r).attr("x2",e).attr("y2",a).style("stroke","black").style("stroke-dasharray","2,2,2")}}),j.forEach(function(t){c(t)});var t=b.validMessageNum*E;k.forEach(function(e){var r=M.get(e),a=r.x+r.width/2-S/2,i=E;d3.select("svg").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:S,height:t}).attr("transform","translate("+a+","+i+")").style("stroke","black").style("fill","#CCC")}),B.forEach(function(t){t.valid&&h(t)})},t.SDViewer=n,Object.defineProperty(t,"__esModule",{value:!0})});