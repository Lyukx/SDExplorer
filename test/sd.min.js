!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.name=t.name,this.parent=-1,this.children=[],this.x=0,this.y=0,this.height=E,this.width=this.name.length*b+2*M,this.fold=!0}function a(t,a){var s=new Map;return t.forEach(function(t){t.name=t.name+":"+t.type;var a=new e(t);s.set(a.id,a)}),a.forEach(function(t){var a=new e(t);a.children=t.objs,s.set(a.id,a)}),a.forEach(function(e){t=e.objs;for(var a=0;a<t.length;a++){s.get(t[a]).parent=e.id}}),s}function s(t,e){G=a(t,e),G.forEach(function(t,e,a){-1==t.parent&&L.push(t)}),L.sort(function(t,e){var a=t.id,s=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(s=e.children[0]),a-s});for(var s=A,r=0;r<L.length;r++)L[r].x=s,s+=L[r].width+A;this.total=G,this.display=L}function r(t){this.from=t.from,this.to=t.to,this.message=t.message,this.callee=t.callee,this.id=-1,this.valid=!1,this.scale=1,this.position=0}function i(t,e){this.loopSet=t,this.stealthSet=e,this.loopSize=t.length}function o(){this.loops=[]}function n(t,e){e.forEach(function(e){t.add(e)})}function l(t,e){this.messages=[],this.origin=[],this.mainThreads=e;for(var a=0;a<t.length;a++){var s=new r(t[a]);s.id=a,this.messages.push(s),this.origin.push({from:s.from,to:s.to})}O=this.origin,V=new o,this.loops=V.detect(t),this.loopStealthSet=V.getAllStealth(),this.firstValidMsg=this.messages[0],this.lastValidMsg=this.messages[this.messages.length-1]}function h(t,e,a){var r=new s(t,e);B=r,D=r.total,P=r.display;var i=new Set;i.add(0);for(var o=D.get(0);-1!=o.parent;)i.add(o.parent),o=D.get(o.parent);j=i;var n=new Set;P.forEach(function(t){t.isGroup()&&!t.fold||n.add(t.id)});var h=new l(a,i);h.updateMessageInit(D,n),h.updateStatus(),H=h.messages,J=h.origin,C=h}function d(){var t=C.lastValidMsg,e=C.firstValidMsg,a=t.position-e.position+_+4*q;j.forEach(function(t){var s=D.get(t),r=s.x+s.width/2-N/2,i=e.position-2*q;d3.select(".messages-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:N,height:a}).attr("transform","translate("+r+","+i+")").style("stroke","black").style("fill","#CCC")})}function f(){var t=C.lastValidMsg,e=C.firstValidMsg,a=t.position-e.position+_+4*q,s=new Set;P.forEach(function(t){t.isGroup()&&!t.fold||s.add(t.id)}),j.forEach(function(t){if(s.has(t)){var r=D.get(t),i=r.x+r.width/2-N/2,o=e.position-2*q;d3.select(".mainThreadActiveBar").attr({x:0,y:0,width:N,height:a}).attr("transform","translate("+i+","+o+")")}})}function c(t){B.unfoldUpdateStatus(t.id);var e=new Set;P.forEach(function(t){t.isGroup()&&!t.fold||e.add(t.id)}),C.updateMessageOnUnfold(D,e),S(t,C.updateStatus()),f(),x()}function p(t){B.foldUpdateStatus(t.id),C.updateMessageOnFold(t),C.updateStatus(),k(t),f(),x()}function g(t){var e=D.get(t.from),a=D.get(t.to),s=e.x+e.width/2-N/2,r=t.position+q,i=t.scale*_-2*q,o=a.x+a.width/2-N/2,n=r+q,l=i-2*q,h=D.get(t.from).x<D.get(t.to).x,d=d3.select(".messages-layout").append("g");h?d.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s+F)+","+r+")"):d.append("text").attr("class","message-text").text(function(e){return t.message}).attr("transform","translate("+(s-N)+","+r+")").attr("text-anchor","end"),d.append("line").attr("class","callLine").style("stroke","black").attr("x1",h?s+N:s).attr("y1",n).attr("x2",h?o:o+N).attr("y2",n).attr("marker-end","url(#end)"),d.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",h?o:o+N).attr("y1",n+l).attr("x2",h?s+N:s).attr("y2",n+l).attr("marker-end","url(#end)"),d.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:N,height:l}).attr("transform","translate("+o+","+n+")").style("stroke","black").style("fill","#CCC"),d.attr("class","message").datum(t)}function u(t){for(var e=0;e<t.children.length;e++){var a=D.get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function m(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,s=(C.validMessageNum+1)*_+z/2+U/2;e.append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",s).style("stroke","black").style("stroke-dasharray","2,2,2");var r=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?r.style("fill","yellow"):r.style("fill","white"),e.append("text").text(function(e){return t.name}).attr("transform","translate("+t.width/2+","+(t.height/2+T)+")").attr("text-anchor","middle"),e.attr("class","element-rectangle").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){if(t.fold)c(t);else{var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(u(a))p(a),e.splice(e.length-1,1);else for(var s=0;s<a.children.length;s++){var r=D.get(a.children[s]);r.isGroup()&&(u(r)?p(r):e.push(r))}}}}),e}function v(t){var e=H[t.loopSet[0]],a=H[t.loopSet[t.loopSet.length-1]],s=0;t.loopSet.forEach(function(t){var e=D.get(H[t].from),a=D.get(H[t].to);a.x-e.x>s&&(s=a.x+a.width-e.x)});var r=D.get(e.from).x,i=e.position-2*q,o=a.position-e.position+_+2*q,n=s,l=d3.select(".loop-layout").append("g");l.append("rect").attr("class","loop").attr({x:0,y:0,width:n,height:o}).style("stroke","#00008B").style("fill-opacity","0"),l.append("rect").attr({x:0,y:0,width:40,height:20}).style("stroke","black").style("fill","#B0E0E6"),l.append("text").text(function(t){return"loop"}).attr("transform","translate(5,14)"),l.attr("transform","translate("+r+","+i+")")}function y(){C.loops.forEach(function(t){v(t)})}function x(){d3.selectAll(".loop").remove(),y()}function w(){d3.selectAll(".message").each(function(t){if(!t.valid)return void d3.select(this).remove();var e=D.get(t.from),a=D.get(t.to),s=e.x+e.width/2-N/2,r=t.position+q,i=t.scale*_-2*q,o=a.x+a.width/2-N/2,n=r+q,l=i-2*q,h=D.get(t.from).x<D.get(t.to).x;h?d3.select(this).select(".message-text").transition().attr("transform","translate("+(s+F)+","+r+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(s-N)+","+r+")"),d3.select(this).select(".callLine").transition().attr("x1",h?s+N:s).attr("y1",n).attr("x2",h?o:o+N).attr("y2",n),d3.select(this).select(".callBackLine").transition().attr("x1",h?o:o+N).attr("y1",n+l).attr("x2",h?s+N:s).attr("y2",n+l),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:N,height:l}).attr("transform","translate("+o+","+n+")")}),d3.selectAll(".baseLine").attr("y2",C.lastValidMsg.position-C.firstValidMsg.position+2*_+z/2+U/2)}function S(t,e){d3.selectAll(".element-rectangle").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select(this).select(".baseLine").style("opacity",0)):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")}),P.forEach(function(t){z=Math.max(z,t.height)});for(var a=0;a<t.children.length;a++){var s=t.children[a],r=D.get(s),i=m(r);i.attr("transform","translate("+t.x+", "+(t.y+I)+")"),i.transition().attr("transform","translate("+r.x+", "+r.y+")")}e.forEach(function(t){g(t)}),w()}function k(t){d3.selectAll(".element-rectangle").each(function(e){-1!=t.children.indexOf(e.id)?d3.select(this).remove():e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),z=Math.max(z,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select(this).select(".baseLine").style("opacity",1)):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")):d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")")}),z=U,P.forEach(function(t){z=Math.max(z,t.height)}),w()}var E=40,b=10,M=20;e.prototype.isGroup=function(){return 0!=this.children.length};var A=20,G=[],L=[];s.prototype.unfoldUpdateStatus=function(t){var e=G.get(t);if(e.fold){for(var a=e.children,s=10,r=L.indexOf(e)+1,i=0;i<a.length;i++){var o=G.get(a[i]);o.x=s+e.x,L.splice(r,0,o),r++,s+=o.width+A}for(var n=s-A+10-e.width;r<L.length;)L[r].x+=n,r++;e.width+=n,e.y-=10,e.height+=20,e.fold=!1;for(var l=e;-1!=l.parent;)l=G.get(l.parent),l.width+=n,l.height+=20,l.y-=10}},s.prototype.foldUpdateStatus=function(t){var e=G.get(t);if(!e.fold){for(var a=e.children,s=0,r=0;r<a.length;r++){var i=G.get(a[r]);s=L.indexOf(i),L.splice(s,1)}for(var o=e.width-(10*e.name.length+2*A);s<L.length;)L[s].x-=o,s++;e.width-=o,e.y+=10,e.height-=20,e.fold=!0;for(var n=e;-1!=n.parent;)n=G.get(n.parent),n.width-=o,n.height-=20,n.y+=10}},r.prototype.equals=function(t){return this.from==t.from&&this.to==t.to&&this.message==t.message&&this.callee==t.callee&&this.scale==t.scale},o.prototype.detect=function(t){var e=[];e.push(0);var a=new Set;a.add(1),a.add(2);var s=new i(e,a),r=[];return r.push(s),this.loops=r,r},o.prototype.getAllStealth=function(){var t=new Set;return this.loops.forEach(function(e){n(t,e.stealthSet)}),t},o.prototype.getAllLoopStart=function(){var t=new Set;return this.loops.forEach(function(e){t.add(e.loopSet[0])}),t},o.prototype.getAllLoopEnd=function(){var t=new Set;return this.loops.forEach(function(e){t.add(e.loopSet[e.loopSet.length-1])}),t};var V,O=[];l.prototype.updateMessageInit=function(t,e){this.messages.forEach(function(a){for(;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}for(;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},l.prototype.updateMessageOnFold=function(t){this.messages.forEach(function(e){-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id)})},l.prototype.updateMessageOnUnfold=function(t,e){this.messages.forEach(function(a){if(!e.has(a.from))for(a.from=O[a.id].from;!e.has(a.from);){var s=t.get(a.from).parent;if(a.from=s,-1==s)break}if(!e.has(a.to))for(a.to=O[a.id].to;!e.has(a.to);){var s=t.get(a.to).parent;if(a.to=s,-1==s)break}})},l.prototype.updateStatus=function(){var t,e=new Set,a=-40,s=0,r=[],i=0;this.loops=V.detect(this.messages),this.loopStealthSet=V.getAllStealth();for(var o=V.getAllLoopStart(),n=V.getAllLoopEnd(),l=0;l<this.messages.length;l++){var h=this.messages[l];if(h.to==h.from||-1==h.from||-1==h.to)h.valid=!1;else if(this.loopStealthSet.has(h.id))h.valid=!1;else if(this.mainThreads.has(h.from))e.clear(),e.add(h.to),h.valid||r.push(h),h.valid=!0,h.scale=1,o.has(h.id)&&(a+=40),a+=80+i,i=0,h.position=a,t=h.id,s++,n.has(h.id)&&(a+=20);else if(e.has(h.from)){e.add(h.to),h.valid||r.push(h),h.valid=!0,h.scale=1,o.has(h.id)&&(a+=40);var d=this.messages[l-1];if(h.from==d.to)a+=40,h.position=a,i+=40;else{for(var f=0,c=d;c.from!=h.from;)f+=40,i-=40,c=this.messages[c.id-1];a+=80+f,h.position=a}for(var p=t;p<l&&(this.messages[p].scale+=1,this.messages[p].to!=h.from);p++);s++,n.has(h.id)&&(a+=20)}else h.valid=!1}for(var g=null,u=null,l=this.messages.length-1;l>=0;l--){var h=this.messages[l];if(h.valid){g=h;break}}for(var l=0;l<this.messages.length;l++){var h=this.messages[l];if(h.valid){u=h;break}}return this.firstValidMsg=u,this.lastValidMsg=g,this.validMessageNum=s,r};var B,j,C,U=40,T=4,F=20,I=10,N=10,_=80,q=_/8,z=U,D=[],P=[],H=[],J=[];h.prototype.drawAll=function(){d3.select("svg").append("g").attr("class","objects-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","loop-layout"),P.forEach(function(t){m(t)}),d(),H.forEach(function(t){t.valid&&g(t)}),y()},t.SDViewer=h,Object.defineProperty(t,"__esModule",{value:!0})});