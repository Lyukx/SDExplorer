!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.sd={})}(this,function(t){"use strict";function e(t){this.id=t.id,this.displayName=t.name,void 0!=t.type&&(this.displayName+=t.type),this.parent=-1,this.children=[],this.fold=!0,this.x=0,this.y=0,this.height=m,this.width=this.displayName.length*x+2*v}function a(t,a){!function(t,a){b=new Map,t.forEach(function(t){var a=new e(t);b.set(a.id,a)}),a.forEach(function(a){var r=new e(a);r.children=a.objs,b.set(r.id,r),t=a.objs;for(var s=0;s<t.length;s++)b.get(t[s]).parent=a.id})}(t,a),b.forEach(function(t,e,a){-1==t.parent&&M.push(t)}),M.sort(function(t,e){var a=t.id,r=e.id;return t.isGroup()&&(a=t.children[0]),e.isGroup()&&(r=e.children[0]),a-r});for(var s=k,n=0;n<M.length;n++)M[n].x=s,s+=M[n].width+k;r()}function r(){w=new Set;for(let t of M)t.isGroup()&&!t.fold||w.add(t.id)}function s(t,e,a,r){L=[],E=new Map,O=[];for(let e of t)r.has(e.from)&&r.has(e.to)&&(O.push(e),E.set(e.id,{from:e.from,to:e.to}));for(let t of O){for(;!a.has(t.from);){if(-1==(s=r.get(t.from).parent))break;t.from=s}for(;!a.has(t.to);){var s=r.get(t.to).parent;if(-1==s)break;t.to=s}}S=e,n()}function n(){var t=new o,e=A/4,a=0,r=[];L=[];for(var s=0;s<O.length;s++){var n=O[s];if(n.to==n.from||-1==n.from||-1==n.to)n.valid=!1;else if(S.has(n.from))e+=(t.stack.length+1)*A/2,n.position=e,(t=new o).push(n),n.fromOffset=t.getOffset(n.from),n.toOffset=t.getOffset(n.to),n.valid||r.push(n),n.valid=!0,n.scale=1,L.push(n);else if(t.hasActive(n.from)){n.valid||r.push(n),n.valid=!0,n.scale=1,L.push(n);for(a=0;t.peek().to!=n.from;){t.pop();a+=1}e+=(a+1)*A/2,n.position=e,t.stack.forEach(function(t){t.scale+=1}),t.push(n),n.fromOffset=t.getOffset(n.from),n.toOffset=t.getOffset(n.to)}else n.valid=!1}return r}function o(){this.stack=[],this.offset=new Map;for(let t of S)this.offset.set(t,0)}function i(t,e,r){for(var n=(D=new a(t,e)).getElementMap(),o=new Set([0]),i=n.get(0);-1!=i.parent;)o.add(i.parent),i=n.get(i.parent);U=[0],G=new s(r,o,D.getDisplaySet(),n)}function l(t){D.unfoldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),e==t?(d3.select(this).transition().style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),e.getDisplay().forEach(function(t){N=Math.max(N,t.height)});for(var a=e.getElementMap(),r=0;r<t.children.length;r++){var s=t.children[r],n=a.get(s),o=h(n);o.attr("transform","translate("+t.x+", "+(t.y+V)+")"),o.transition().attr("transform","translate("+n.x+", "+n.y+")"),d3.select("#baseLine"+s).transition().attr("transform","translate("+n.x+", "+n.y+")")}}(t,D);g(G.unfoldUpdateStatus(D.getDisplaySet(),D.getElementMap()))}function f(t){D.foldUpdateStatus(t.id),function(t,e){d3.selectAll(".element").each(function(e){-1!=t.children.indexOf(e.id)?(d3.select("#baseLine"+e.id).remove(),d3.select(this).remove()):e.isGroup()?(d3.select(this).select("rect").transition().attr({width:e.width,height:e.height}),N=Math.max(N,e.height),e==t?(d3.select(this).transition().style("fill-opacity","1").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().style("opacity",1).attr("transform","translate("+e.x+", "+e.y+")")):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).transition().attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).transition().attr("transform","translate("+e.x+", "+e.y+")"))}),N=B,e.getDisplay().forEach(function(t){N=Math.max(N,t.height)})}(t,D),G.unfoldUpdateStatus(D.getDisplaySet(),D.getElementMap()),g([])}function c(t){for(var e=0;e<t.children.length;e++){var a=D.getElementMap().get(t.children[e]);if(a.isGroup()&&!a.fold)return!1}return!0}function d(){d3.select("svg").append("g").attr("class","baseline-layout"),d3.select("svg").append("g").attr("class","loop-layout"),d3.select("svg").append("g").attr("class","mainthread-layout"),d3.select("svg").append("g").attr("class","messages-layout"),d3.select("svg").append("g").attr("class","objects-layout").attr("transform","translate(0, 0)")}function h(t){var e=d3.select(".objects-layout").append("g"),a=t.width/2,r=G.getValidMessages().length*I+B+I/2;d3.select(".baseline-layout").append("line").attr("class","baseLine").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",r).style("stroke","black").style("stroke-dasharray","2,2,2").attr("id","baseLine"+t.id).attr("transform","translate("+t.x+", "+t.y+")");var s=e.append("rect").attr({x:0,y:0,width:t.width,height:t.height}).style("stroke","black");return t.isGroup()?s.style("fill","yellow"):s.style("fill","white"),e.append("text").text(function(e){return t.displayName}).attr("transform","translate("+t.width/2+","+(t.height/2+j)+")").attr("text-anchor","middle"),e.attr("class","element").datum(t).attr("transform","translate("+t.x+", "+t.y+")"),t.isGroup()&&e.on("click",function(t){t.fold?l(t):function(t){var e=[];for(e.push(t);0!=e.length;){var a=e[e.length-1];if(c(a))f(a),e.splice(e.length-1,1);else for(var r=0;r<a.children.length;r++){var s=D.getElementMap().get(a.children[r]);s.isGroup()&&(c(s)?f(s):e.push(s))}}}(t)}),e}function p(t){var e=D.getElementMap(),a=e.get(t.from),r=e.get(t.to),s=a.x+a.width/2-F/2+t.fromOffset*F,n=t.position+T,o=t.scale*I-2*T,i=r.x+r.width/2-F/2+t.toOffset*F,l=n+T,f=o-2*T,c=e.get(t.from).x<e.get(t.to).x,d=d3.select(".messages-layout").append("g"),h=d.append("text").attr("class","message-text").text(function(e){return t.message});c?h.attr("transform","translate("+(s+C)+","+n+")"):h.attr("transform","translate("+(s-F)+","+n+")").attr("text-anchor","end"),d.append("line").attr("class","callLine").style("stroke","black").attr("x1",c?s+F:s).attr("y1",l).attr("x2",c?i:i+F).attr("y2",l).attr("marker-end","url(#end)"),d.append("line").attr("class","callBackLine").style("stroke","black").style("stroke-dasharray","5, 5, 5").attr("x1",c?i:i+F).attr("y1",l+f).attr("x2",c?s+F:s).attr("y2",l+f).attr("marker-end","url(#end)"),d.append("rect").attr("class","rightActiveBlock").attr({x:0,y:0,width:F,height:f}).attr("transform","translate("+i+","+l+")").style("stroke","black").style("fill","#CCC"),d.attr("class","message").datum(t)}function g(t){for(let e of t)e.valid&&p(e);var e=D.getElementMap();d3.selectAll(".message").each(function(t){if(t.valid){var a=e.get(t.from),r=e.get(t.to),s=a.x+a.width/2-F/2+t.fromOffset*F,n=t.position+T,o=t.scale*I-2*T,i=r.x+r.width/2-F/2+t.toOffset*F,l=n+T,f=o-2*T,c=e.get(t.from).x<e.get(t.to).x;c?d3.select(this).select(".message-text").transition().attr("transform","translate("+(s+C)+","+n+")"):d3.select(this).select(".message-text").transition().attr("transform","translate("+(s-F)+","+n+")"),d3.select(this).select(".callLine").transition().attr("x1",c?s+F:s).attr("y1",l).attr("x2",c?i:i+F).attr("y2",l),d3.select(this).select(".callBackLine").transition().attr("x1",c?i:i+F).attr("y1",l+f).attr("x2",c?s+F:s).attr("y2",l+f),d3.select(this).select(".rightActiveBlock").transition().attr({x:0,y:0,width:F,height:f}).attr("transform","translate("+i+","+l+")"),d3.select(this).select(".message-click-active-block").transition().attr({x:-C,y:-C,width:2*C+Math.abs(i-s),height:2*C+f}).attr("transform","translate("+Math.min(s,i)+","+l+")")}else d3.select(this).remove()});var a=G.getValidMessages().length*I+B+I/2;d3.selectAll(".baseLine").attr("y2",a),y()}function u(){var t=D.getElementMap(),e=D.getDisplaySet();for(let o of U){for(var a=t.get(o);!e.has(a.id)&&-1!=a.parent;)a=t.get(a.parent);var r=a.x+a.width/2-F/2,s=.75*I,n=G.getValidMessages().length*I;d3.select(".mainthread-layout").append("rect").attr("class","mainThreadActiveBar").attr({x:0,y:0,width:F,height:n}).attr("transform","translate("+r+","+s+")").style("stroke","black").style("fill","#CCC")}}function y(){d3.selectAll(".mainThreadActiveBar").remove(),u()}var m=40,x=10,v=20;e.prototype.isGroup=function(){return 0!=this.children.length};var w,k=20,b=[],M=[];a.prototype.getElementMap=function(){return b},a.prototype.getDisplay=function(){return M},a.prototype.getDisplaySet=function(){return w},a.prototype.getGroupFoldInfo=function(){var t=new Set;for(let e of M)e.isGroup()&&!e.fold&&t.add(e.id);return t},a.prototype.unfoldUpdateStatus=function(t){var e=b.get(t);if(e.fold){for(var a=e.children,s=10,n=M.indexOf(e)+1,o=0;o<a.length;o++){var i=b.get(a[o]);i.x=s+e.x,M.splice(n,0,i),n++,s+=i.width+k}for(var l=s-k+10-e.width;n<M.length;)M[n].x+=l,n++;e.width+=l,e.y-=10,e.height+=20,e.fold=!1;for(var f=e;-1!=f.parent;)(f=b.get(f.parent)).width+=l,f.height+=20,f.y-=10;r()}},a.prototype.foldUpdateStatus=function(t){var e=b.get(t);if(!e.fold){for(var a=e.children,s=0,n=0;n<a.length;n++){var o=b.get(a[n]);s=M.indexOf(o),M.splice(s,1)}for(var i=e.width-(10*e.displayName.length+2*k);s<M.length;)M[s].x-=i,s++;e.width-=i,e.y+=10,e.height-=20,e.fold=!0;for(var l=e;-1!=l.parent;)(l=b.get(l.parent)).width-=i,l.height-=20,l.y+=10;r()}};var L,E,O,S,A=80;s.prototype.getValidMessages=function(){return L},s.prototype.foldUpdateStatus=function(t){for(let e of O)-1!=t.children.indexOf(e.from)&&(e.from=t.id),-1!=t.children.indexOf(e.to)&&(e.to=t.id);n()},s.prototype.unfoldUpdateStatus=function(t,e){for(let r of O){if(!t.has(r.from))for(r.from=E.get(r.id).from;!t.has(r.from);){if(-1==(a=e.get(r.from).parent))break;r.from=a}if(!t.has(r.to))for(r.to=E.get(r.id).to;!t.has(r.to);){var a=e.get(r.to).parent;if(-1==a)break;r.to=a}}return n()},o.prototype.push=function(t){this.stack.push(t),this.offset.has(t.to)?this.offset.set(t.to,this.offset.get(t.to)+1):this.offset.set(t.to,0)},o.prototype.pop=function(){var t=this.stack.pop(),e=this.offset.get(t.to)-1;return e<0?this.offset.delete(t.to):this.offset.set(t.to,e),t},o.prototype.peek=function(){return this.stack[this.stack.length-1]},o.prototype.hasActive=function(t){return this.offset.has(t)},o.prototype.getOffset=function(t){return this.offset.has(t)?this.offset.get(t):0};var D,G,U;i.prototype.draw=function(){d();for(var t=D.getDisplay(),e=0;e<t.length;e++)h(t[e]);u();var a=G.getValidMessages();for(let t of a)p(t)},i.prototype.getMessages=function(){return G.getValidMessages()},i.prototype.getElements=function(){return D.getDisplay()},i.prototype.clearAll=function(){d3.select(".messages-layout").remove(),d3.select(".objects-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".loop-layout").remove(),d3.select(".mainthread-layout").remove(),d()},i.prototype.getFoldInfo=function(){return D.getGroupFoldInfo()},i.prototype.updateWithoutAnimation=function(t){for(let e of D.getDisplay())if(t.has(e.id)){D.unfoldUpdateStatus(group.id),function(t,e){d3.selectAll(".element").each(function(e){e.isGroup()?(d3.select(this).select("rect").attr({width:e.width,height:e.height}),e==t?(d3.select(this).style("fill-opacity","0").attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")").style("opacity",0)):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))):(d3.select(this).attr("transform","translate("+e.x+", "+e.y+")"),d3.select("#baseLine"+e.id).attr("transform","translate("+e.x+", "+e.y+")"))}),e.getDisplay().forEach(function(t){N=Math.max(N,t.height)});for(var a=e.getElementMap(),r=0;r<t.children.length;r++){var s=t.children[r],n=a.get(s),o=h(n);o.attr("transform","translate("+t.x+", "+(t.y+V)+")"),o.attr("transform","translate("+n.x+", "+n.y+")"),d3.select("#baseLine"+s).attr("transform","translate("+n.x+", "+n.y+")")}}(group,D);!function(t){for(let e of t)e.valid&&p(e);var e=D.getElementMap();d3.selectAll(".message").each(function(t){if(t.valid){var a=e.get(t.from),r=e.get(t.to),s=a.x+a.width/2-F/2+t.fromOffset*F,n=t.position+T,o=t.scale*I-2*T,i=r.x+r.width/2-F/2+t.toOffset*F,l=n+T,f=o-2*T,c=e.get(t.from).x<e.get(t.to).x;c?d3.select(this).select(".message-text").attr("transform","translate("+(s+C)+","+n+")"):d3.select(this).select(".message-text").attr("transform","translate("+(s-F)+","+n+")"),d3.select(this).select(".callLine").attr("x1",c?s+F:s).attr("y1",l).attr("x2",c?i:i+F).attr("y2",l),d3.select(this).select(".callBackLine").attr("x1",c?i:i+F).attr("y1",l+f).attr("x2",c?s+F:s).attr("y2",l+f),d3.select(this).select(".rightActiveBlock").attr({x:0,y:0,width:F,height:f}).attr("transform","translate("+i+","+l+")"),d3.select(this).select(".message-click-active-block").attr({x:-C,y:-C,width:2*C+Math.abs(i-s),height:2*C+f}).attr("transform","translate("+Math.min(s,i)+","+l+")")}else d3.select(this).remove()});var a=G.getValidMessages().length*I+B+I;d3.selectAll(".baseLine").attr("y2",a),y()}(G.unfoldUpdateStatus(D.getDisplaySet(),D.getElementMap()))}};var B=40,j=4,C=20,V=10,N=B,F=10,I=80,T=I/8;t.SDController=i,Object.defineProperty(t,"__esModule",{value:!0})});